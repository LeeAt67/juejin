// æ¸¸æˆæ•°æ® - æ‰©å±•çš„å¤æ‚æ•…äº‹
const gameStory = {
    murderer: "æ±¤å§†Â·å¨å°”é€Š",
    victim: "æ¯”å°”Â·å“ˆé‡Œæ£®",
    location: "é‡‘å¶å’–å•¡é¦†",
    timeOfDeath: "æ™šä¸Š8:30",

    // ä¸»è¦è§’è‰²ä¿¡æ¯11
    characters: {
        "è‰¾ç±³ä¸½": {
            name: "è‰¾ç±³ä¸½Â·é™ˆ",
            role: "å’–å•¡é¦†è€æ¿",
            age: 35,
            motive: "æˆ¿ç§Ÿå‹åŠ›ï¼Œä½†çœŸå¿ƒå…³å¿ƒæ¯”å°”",
            alibi: "8:20-8:40åœ¨åå¨å‡†å¤‡æ˜å¤©çš„ç³•ç‚¹",
            secrets: "æ›¾ç»æš—æ‹æ¯”å°”ï¼Œä½†ä»æœªè¡¨éœ²"
        },
        "é©¬å…‹": {
            name: "é©¬å…‹Â·æ±¤æ™®æ£®",
            role: "ç¼–è¾‘",
            age: 40,
            motive: "ç‰ˆç¨åˆ†æˆäº‰è®®ï¼Œä½†éœ€è¦æ¯”å°”ç»§ç»­åˆ›ä½œ",
            alibi: "8:15-8:35ä¸æ¯”å°”åœ¨åº§ä½ä¸Šè®¨è®ºåˆåŒ",
            secrets: "å…¬å¸è´¢åŠ¡å›°éš¾ï¼Œæ€¥éœ€æ¯”å°”çš„æ–°ä¹¦æ•‘å¸‚"
        },
        "ç‘ç§‹": {
            name: "ç‘ç§‹Â·æ ¼æ—",
            role: "å‰å¦»å¾‹å¸ˆ",
            age: 38,
            motive: "è´¢äº§åˆ†å‰²ï¼Œä½†å·²åŸºæœ¬è¾¾æˆåè®®",
            alibi: "8:25-8:45åœ¨å’–å•¡é¦†è§’è½æ‰“ç”µè¯",
            secrets: "ä»ç„¶çˆ±ç€æ¯”å°”ï¼Œæƒ³è¦å¤åˆ"
        },
        "æ°å…‹": {
            name: "æ°å…‹Â·å¸ƒæœ—",
            role: "å¹´è½»æ¼”å‘˜",
            age: 28,
            motive: "æ¯”å°”'ç›—ç”¨'äº†ä»–çš„æ•…äº‹åˆ›æ„",
            alibi: "8:00-8:20åœ¨å’–å•¡é¦†è¯»å‰§æœ¬",
            secrets: "ç»æµæ‹®æ®ï¼Œæ€¥éœ€ç‰ˆæƒè´¹ç»´ç”Ÿ"
        },
        "æ±¤å§†": {
            name: "æ±¤å§†Â·å¨å°”é€Š",
            role: "æœåŠ¡å‘˜/åŒ»å­¦ç”Ÿ",
            age: 22,
            motive: "æ¯”å°”å‘ç°äº†ä»–çš„å­¦æœ¯é€ å‡å¹¶å¨èƒä¸¾æŠ¥",
            alibi: "8:20-8:35è´Ÿè´£æœåŠ¡æ¯”å°”åŒºåŸŸ",
            secrets: "ä¸ºäº†å­¦è´¹ä¼ªé€ å®éªŒæ•°æ®ï¼Œå³å°†è¢«å‘ç°"
        },
        "è¨æ‹‰": {
            name: "è¨æ‹‰Â·æˆ´ç»´æ–¯",
            role: "ä¹¦è¿·",
            age: 30,
            motive: "æ¯”å°”çš„æ–°ä¹¦æŠ„è¢­äº†å¥¹çš„æŠ•ç¨¿",
            alibi: "8:15-8:45ååœ¨é™„è¿‘æ¡Œå­è§‚å¯Ÿ",
            secrets: "æ›¾è¢«æ¯”å°”æ‹’ç»è¿‡æ±‚çˆ±"
        }
    },

    // å…³é”®çº¿ç´¢
    clues: [
        "ç‰¹åˆ¶æ‹¿é“å’–å•¡", "æ°°åŒ–ç‰©ä¸­æ¯’", "åŒ»å­¦é™¢å­¦ç”Ÿ", "å­¦æœ¯é€ å‡",
        "å¨èƒä¸¾æŠ¥", "æœåŠ¡å‘˜", "æ±¤å§†", "åŒ–å­¦çŸ¥è¯†", "è¯ç†å­¦", "å®éªŒæ•°æ®",
        "æ™šä¸Š8:30", "é‡‘å¶å’–å•¡é¦†", "æ²¡æœ‰æ‰“æ–—ç—•è¿¹", "é¢è‰²å‘ç´«", "å‘¼å¸æ€¥ä¿ƒ",
        "ç‰¹åˆ¶æ‹¿é“", "å›ºå®šåº§ä½", "å¸¸å®¢", "æ‰‹ç¨¿", "æ­»äº¡çš„çœŸç›¸", "ç‰ˆç¨äº‰è®®",
        "è´¢äº§åˆ†å‰²", "æ•…äº‹åˆ›æ„", "å­¦è´¹å‹åŠ›", "æˆ¿ç§Ÿä¸Šæ¶¨", "å¤åˆæ„¿æœ›"
    ],

    // è¯¦ç»†æ¡ˆä»¶ä¿¡æ¯
    details: [
        "æ¯”å°”æ˜¯è‘—åä¾¦æ¢å°è¯´å®¶ï¼Œæ¯å¤©éƒ½æ¥å’–å•¡é¦†çš„å›ºå®šåº§ä½å†™ä½œ",
        "å½“æ™šæ¯”å°”åœ¨æ’°å†™æ–°å°è¯´ã€Šæ­»äº¡çš„çœŸç›¸ã€‹",
        "æ¯”å°”æœ€è¿‘å‘ç°æ±¤å§†åœ¨åŒ»å­¦é™¢çš„å®éªŒæ•°æ®é€ å‡",
        "æ±¤å§†å› ä¸ºå®¶åº­è´«å›°ï¼Œä¸ºäº†è·å¾—å¥–å­¦é‡‘è€Œä¼ªé€ æ•°æ®",
        "æ¯”å°”å¨èƒè¦ä¸¾æŠ¥æ±¤å§†ï¼Œè¿™ä¼šæ¯æ‰æ±¤å§†çš„å­¦ä¸šå’Œå‰é€”",
        "æ±¤å§†åˆ©ç”¨åŒ»å­¦çŸ¥è¯†ï¼Œåœ¨æ¯”å°”çš„ç‰¹åˆ¶æ‹¿é“ä¸­åŠ å…¥äº†æ°°åŒ–ç‰©",
        "ç°åœºæ²¡æœ‰æ‰“æ–—ç—•è¿¹ï¼Œè¯´æ˜å—å®³è€…å¯¹å‡¶æ‰‹æ²¡æœ‰é˜²å¤‡",
        "æ±¤å§†ä½œä¸ºæœåŠ¡å‘˜ï¼Œæœ‰å……åˆ†çš„æœºä¼šæ¥è§¦æ¯”å°”çš„å’–å•¡",
        "å…¶ä»–è§’è‰²è™½ç„¶éƒ½æœ‰åŠ¨æœºï¼Œä½†éƒ½æœ‰ç›¸å¯¹å……åˆ†çš„ä¸åœ¨åœºè¯æ˜",
        "æ±¤å§†çš„åŒ»å­¦èƒŒæ™¯è®©ä»–çŸ¥é“å¦‚ä½•ä½¿ç”¨æ¯’ç‰©è€Œä¸è¢«ç«‹å³å‘ç°"
    ],

    // æ—¶é—´çº¿
    timeline: {
        "8:00": "æ¯”å°”è¿›å…¥å’–å•¡é¦†ï¼Œåœ¨å›ºå®šåº§ä½å¼€å§‹å†™ä½œ",
        "8:05": "è‰¾ç±³ä¸½ä¸ºæ¯”å°”è°ƒåˆ¶ç‰¹åˆ¶æ‹¿é“",
        "8:10": "æ°å…‹åœ¨å’–å•¡é¦†è§’è½è¯»å‰§æœ¬",
        "8:15": "é©¬å…‹åˆ°è¾¾ï¼Œä¸æ¯”å°”è®¨è®ºæ–°ä¹¦åˆåŒ",
        "8:20": "æ±¤å§†å¼€å§‹æœåŠ¡æ¯”å°”æ‰€åœ¨åŒºåŸŸ",
        "8:22": "æ±¤å§†åœ¨ç«¯å’–å•¡æ—¶å‘æ¯ä¸­æŠ•æ¯’",
        "8:25": "ç‘ç§‹è¿›å…¥å’–å•¡é¦†ï¼Œåœ¨è§’è½æ‰“ç”µè¯",
        "8:28": "æ¯”å°”å–ä¸‹è¢«ä¸‹æ¯’çš„å’–å•¡",
        "8:30": "æ¯”å°”å¼€å§‹å‡ºç°ä¸­æ¯’ç—‡çŠ¶ï¼Œéšåæ­»äº¡",
        "8:35": "å‘ç°æ¯”å°”æ­»äº¡ï¼Œå’–å•¡é¦†é™·å…¥æ··ä¹±"
    }
};

// AI APIé…ç½®
const AI_CONFIG = {
    apiKey: '894dcbf9-7049-4cbe-9053-9f47b7aa8a52',
    endpoint: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
    model: 'doubao-1-5-pro-32k-250115'
};

// è¯äººè¯è¯ç³»ç»Ÿ
const WITNESS_TESTIMONIES = {
    'è‰¾ç±³ä¸½': {
        name: 'è‰¾ç±³ä¸½Â·é™ˆ',
        role: 'å’–å•¡é¦†è€æ¿',
        age: 35,
        testimonies: [
            'é‚£å¤©æ™šä¸Š8ç‚¹å·¦å³ï¼Œæ¯”å°”åƒå¾€å¸¸ä¸€æ ·æ¥åˆ°å’–å•¡é¦†ã€‚ä»–æ¯å¤©éƒ½æ˜¯è¿™ä¸ªæ—¶é—´æ¥ï¼Œé›·æ‰“ä¸åŠ¨ã€‚',
            'æˆ‘æ³¨æ„åˆ°ä»–ä»Šå¤©çœ‹èµ·æ¥æœ‰ç‚¹å¿ƒä¸åœ¨ç„‰ï¼Œä¸€ç›´åœ¨çœ‹æ‰‹æœºï¼Œå¥½åƒåœ¨ç­‰ä»€ä¹ˆæ¶ˆæ¯ã€‚',
            'æ±¤å§†æ˜¯æœ€åä¸€ä¸ªæ¥è§¦æ¯”å°”å’–å•¡çš„äººã€‚ä»–åˆšæ¥å’–å•¡é¦†å·¥ä½œä¸ä¹…ï¼Œä½†åšäº‹å¾ˆè®¤çœŸã€‚',
            'æ¯”å°”çš„æ­»è®©æˆ‘å¾ˆéœ‡æƒŠã€‚ä»–æ˜¯æˆ‘åº—é‡Œçš„å¸¸å®¢ï¼Œæˆ‘ä»¬å…³ç³»ä¸é”™ï¼Œæˆ‘æ€ä¹ˆå¯èƒ½å®³ä»–ï¼Ÿ',
            'æœ€è¿‘æˆ¿ç§Ÿç¡®å®æ¶¨äº†ï¼Œä½†æˆ‘æœ‰å…¶ä»–æ”¶å…¥æ¥æºï¼Œä¸è‡³äºä¸ºäº†é’±åšè¿™ç§äº‹ã€‚',
            'æˆ‘8:20-8:40åœ¨åå¨å‡†å¤‡æ˜å¤©çš„ç³•ç‚¹ï¼ŒæœŸé—´å‡ºæ¥è¿‡ä¸¤æ¬¡ï¼Œçœ‹åˆ°æ±¤å§†åœ¨æœåŠ¡æ¯”å°”é‚£æ¡Œã€‚',
            'æ¯”å°”çš„å’–å•¡æ˜¯æˆ‘ç‰¹åˆ¶çš„é…æ–¹ï¼Œåªæœ‰æˆ‘çŸ¥é“å…·ä½“æˆåˆ†ã€‚ä½†é‚£å¤©æˆ‘å¤ªå¿™äº†ï¼Œè®©æ±¤å§†å¸®å¿™ç«¯è¿‡å»ã€‚',
            'æˆ‘æ³¨æ„åˆ°æ±¤å§†æœ€è¿‘ç»å¸¸åœ¨ä¼‘æ¯æ—¶é—´çœ‹åŒ»å­¦ä¹¦ç±ï¼Œå¥½åƒæ˜¯åœ¨å‡†å¤‡ä»€ä¹ˆè€ƒè¯•ã€‚'
        ]
    },
    'é©¬å…‹': {
        name: 'é©¬å…‹Â·æ±¤æ™®æ£®',
        role: 'ç¼–è¾‘',
        age: 40,
        testimonies: [
            'æˆ‘å’Œæ¯”å°”çº¦å¥½é‚£å¤©æ™šä¸Šè®¨è®ºæ–°ä¹¦çš„å‡ºç‰ˆäº‹å®œã€‚ä»–æœ€è¿‘åœ¨å†™ä¸€éƒ¨å…³äºå­¦æœ¯é€ å‡çš„å°è¯´ã€‚',
            'æˆ‘åˆ°å’–å•¡é¦†æ—¶å·²ç»8:15äº†ï¼Œçœ‹åˆ°æ¯”å°”æ­£åœ¨å–å’–å•¡ã€‚æˆ‘ä»¬èŠäº†å¤§çº¦10åˆ†é’Ÿã€‚',
            'æˆ‘ä»¬ç¡®å®åœ¨ç‰ˆç¨é—®é¢˜ä¸Šæœ‰äº›åˆ†æ­§ï¼Œä½†è¿™æ˜¯æ­£å¸¸çš„å•†ä¸šè°ˆåˆ¤ï¼Œä¸è‡³äºé—¹åˆ°è¿™ç§åœ°æ­¥ã€‚',
            'å…¬å¸æœ€è¿‘ç¡®å®é‡åˆ°ä¸€äº›è´¢åŠ¡å›°éš¾ï¼Œä½†æ¯”å°”çš„ä¸‹ä¸€æœ¬ä¹¦å¯¹æˆ‘ä»¬å¾ˆé‡è¦ï¼Œæˆ‘ä¸å¯èƒ½å®³ä»–ã€‚',
            'æˆ‘ç¦»å¼€æ—¶æ¯”å°”è¿˜å¥½å¥½çš„ï¼Œæ²¡æƒ³åˆ°ä¼šå‘ç”Ÿè¿™ç§äº‹ã€‚',
            'æ¯”å°”æåˆ°ä»–æœ€è¿‘å‘ç°äº†ä¸€äº›å…³äºå­¦æœ¯é€ å‡çš„è¯æ®ï¼Œå‡†å¤‡å†™è¿›æ–°ä¹¦é‡Œã€‚',
            'æˆ‘æ³¨æ„åˆ°æ±¤å§†åœ¨é€å’–å•¡æ—¶ï¼Œæ‰‹æœ‰ç‚¹å‘æŠ–ï¼Œå¥½åƒå¾ˆç´§å¼ çš„æ ·å­ã€‚',
            'æ¯”å°”è¯´ä»–çš„æ–°ä¹¦ä¼šæ­éœ²ä¸€äº›æƒŠäººçš„çœŸç›¸ï¼Œå¯èƒ½ä¼šå½±å“åˆ°æŸäº›äººçš„å‰é€”ã€‚'
        ]
    },
    'ç‘ç§‹': {
        name: 'ç‘ç§‹Â·æ ¼æ—',
        role: 'å‰å¦»å¾‹å¸ˆ',
        age: 38,
        testimonies: [
            'æˆ‘æ˜¯æ¯”å°”çš„ç¦»å©šå¾‹å¸ˆï¼Œä½†æˆ‘ä»¬ä¹‹é—´ä¸åªæ˜¯å·¥ä½œå…³ç³»ã€‚æˆ‘æ‰¿è®¤æˆ‘å¯¹ä»–è¿˜æœ‰æ„Ÿæƒ…ã€‚',
            'é‚£å¤©æ™šä¸Šæˆ‘æ˜¯æ¥å’Œä»–è®¨è®ºè´¢äº§åˆ†å‰²çš„äº‹ï¼Œä½†ä¸»è¦æ˜¯æƒ³å’Œä»–è°ˆè°ˆå¤åˆçš„å¯èƒ½ã€‚',
            'æˆ‘çœ‹åˆ°ä»–å–å’–å•¡æ—¶æœ‰ç‚¹å¿ƒä¸åœ¨ç„‰ï¼Œå¥½åƒåœ¨æ‹…å¿ƒä»€ä¹ˆã€‚',
            'æˆ‘ä»¬ç¡®å®å› ä¸ºè´¢äº§åˆ†å‰²æœ‰è¿‡äº‰æ‰§ï¼Œä½†é‚£éƒ½æ˜¯è¿‡å»çš„äº‹äº†ã€‚æˆ‘ç°åœ¨åªæƒ³å’Œä»–é‡æ–°å¼€å§‹ã€‚',
            'æˆ‘ç¦»å¼€æ—¶æ˜¯8:25ï¼Œä»–çœ‹èµ·æ¥ä¸€åˆ‡æ­£å¸¸ã€‚',
            'æˆ‘æ³¨æ„åˆ°æ±¤å§†åœ¨é€å’–å•¡æ—¶ï¼Œç‰¹æ„é¿å¼€äº†æ¯”å°”çš„è§†çº¿ï¼Œè¿™è®©æˆ‘è§‰å¾—æœ‰ç‚¹å¥‡æ€ªã€‚',
            'æ¯”å°”æåˆ°ä»–æœ€è¿‘åœ¨è°ƒæŸ¥ä¸€äº›å­¦æœ¯é€ å‡çš„äº‹æƒ…ï¼Œè¯´è¿™å¯èƒ½ä¼šå½±å“åˆ°ä¸€ä¸ªå¹´è½»äººçš„å‰é€”ã€‚',
            'æˆ‘ç¦»å¼€å‰ï¼Œçœ‹åˆ°æ±¤å§†åœ¨è§’è½é‡Œå·å·æ‰“ç”µè¯ï¼Œè¡¨æƒ…å¾ˆç´§å¼ ã€‚'
        ]
    },
    'æ°å…‹': {
        name: 'æ°å…‹Â·å¸ƒæœ—',
        role: 'æ¼”å‘˜',
        age: 28,
        testimonies: [
            'æ¯”å°”çš„æ–°å°è¯´ã€Šæ­»äº¡çš„çœŸç›¸ã€‹ç”¨äº†æˆ‘çš„æ•…äº‹åˆ›æ„ï¼Œä½†æ²¡æœ‰ç»™æˆ‘ä»»ä½•è¡¥å¿ã€‚',
            'æˆ‘é‚£å¤©æ˜¯å»æ‰¾ä»–ç†è®ºçš„ï¼Œä½†çœ‹åˆ°ä»–åœ¨å’Œåˆ«äººè°ˆè¯ï¼Œå°±åœ¨æ—è¾¹ç­‰ç€ã€‚',
            'æˆ‘ç¡®å®å¾ˆç”Ÿæ°”ï¼Œä½†æˆ‘ä¸å¯èƒ½ä¸ºäº†ä¸€ä¸ªæ•…äº‹åˆ›æ„å°±æ€äººã€‚',
            'æˆ‘æ³¨æ„åˆ°é‚£ä¸ªæœåŠ¡å‘˜æ±¤å§†ä¸€ç›´åœ¨è§‚å¯Ÿæ¯”å°”ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹å¯ç–‘ã€‚',
            'æˆ‘ç­‰åˆ°8:20å°±ç¦»å¼€äº†ï¼Œå› ä¸ºçœ‹åˆ°ä»–åœ¨å¿™ï¼Œæ‰“ç®—æ”¹å¤©å†æ¥ã€‚',
            'æˆ‘çœ‹åˆ°æ±¤å§†åœ¨é€å’–å•¡å‰ï¼Œåœ¨å§å°åé¢åœç•™äº†å¾ˆä¹…ï¼Œå¥½åƒåœ¨å‡†å¤‡ä»€ä¹ˆã€‚',
            'æ¯”å°”æœ€è¿‘åœ¨å†™ä¸€éƒ¨å…³äºå­¦æœ¯é€ å‡çš„å°è¯´ï¼Œè¯´è¿™å¯èƒ½ä¼šå½±å“åˆ°ä¸€ä¸ªåŒ»å­¦ç”Ÿçš„å‰é€”ã€‚',
            'æˆ‘æ³¨æ„åˆ°æ±¤å§†çš„åŒ»å­¦ä¹¦ç±ä¸Šæœ‰å¾ˆå¤šå…³äºæ¯’ç†å­¦çš„ç¬”è®°ï¼Œè¿™è®©æˆ‘è§‰å¾—æœ‰ç‚¹å¥‡æ€ªã€‚'
        ]
    },
    'è¨æ‹‰': {
        name: 'è¨æ‹‰Â·æˆ´ç»´æ–¯',
        role: 'ä¹¦è¿·',
        age: 30,
        testimonies: [
            'æˆ‘æ˜¯æ¯”å°”çš„å¿ å®è¯»è€…ï¼Œç»å¸¸æ¥å’–å•¡é¦†çœ‹ä»–å†™ä½œã€‚',
            'é‚£å¤©æ™šä¸Šæˆ‘æ˜¯æ¥ç»™ä»–çœ‹æˆ‘å†™çš„æ–°æ•…äº‹ï¼Œå¸Œæœ›èƒ½å¾—åˆ°ä»–çš„æŒ‡å¯¼ã€‚',
            'æˆ‘æ³¨æ„åˆ°ä»–ä»Šå¤©ç‰¹åˆ«å…³æ³¨æ‰‹æœºï¼Œå¥½åƒåœ¨ç­‰ä»€ä¹ˆé‡è¦æ¶ˆæ¯ã€‚',
            'æˆ‘ç¡®å®æ›¾ç»å‘ä»–è¡¨ç™½è¿‡ï¼Œä½†è¢«æ‹’ç»äº†ã€‚è¿™è®©æˆ‘å¾ˆä¼¤å¿ƒï¼Œä½†æˆ‘ä¸å¯èƒ½å› æ­¤ä¼¤å®³ä»–ã€‚',
            'æˆ‘ä¸€ç›´åœ¨å’–å•¡é¦†å¾…åˆ°8:30ï¼Œäº²çœ¼çœ‹åˆ°ä»–çªç„¶å€’ä¸‹ã€‚',
            'æˆ‘çœ‹åˆ°æ±¤å§†åœ¨é€å’–å•¡å‰ï¼Œåœ¨å§å°åé¢åœç•™äº†å¾ˆä¹…ï¼Œå¥½åƒåœ¨å‡†å¤‡ä»€ä¹ˆã€‚',
            'æ¯”å°”æœ€è¿‘åœ¨å†™ä¸€éƒ¨å…³äºå­¦æœ¯é€ å‡çš„å°è¯´ï¼Œè¯´è¿™å¯èƒ½ä¼šå½±å“åˆ°ä¸€ä¸ªåŒ»å­¦ç”Ÿçš„å‰é€”ã€‚',
            'æˆ‘æ³¨æ„åˆ°æ±¤å§†çš„åŒ»å­¦ä¹¦ç±ä¸Šæœ‰å¾ˆå¤šå…³äºæ¯’ç†å­¦çš„ç¬”è®°ï¼Œè¿™è®©æˆ‘è§‰å¾—æœ‰ç‚¹å¥‡æ€ªã€‚',
            'åœ¨æ¯”å°”å€’ä¸‹å‰ï¼Œæˆ‘çœ‹åˆ°ä»–å–äº†ä¸€å£å’–å•¡ï¼Œç„¶åè¡¨æƒ…çªç„¶å˜å¾—å¾ˆå¥‡æ€ªã€‚'
        ]
    },
    'æ±¤å§†': {
        name: 'æ±¤å§†Â·å¨å°”é€Š',
        role: 'æœåŠ¡å‘˜',
        age: 22,
        testimonies: [
            'æˆ‘æ˜¯å’–å•¡é¦†çš„å…¼èŒæœåŠ¡å‘˜ï¼Œåœ¨åŒ»å­¦é™¢è¯»å¤§ä¸‰ã€‚',
            'é‚£å¤©æ™šä¸Šæˆ‘è´Ÿè´£æ¯”å°”é‚£æ¡Œçš„æœåŠ¡ï¼Œä»–ç‚¹äº†ä¸€æ¯ç‰¹åˆ¶æ‹¿é“ã€‚',
            'æˆ‘ç¡®å®æœ‰æœºä¼šæ¥è§¦ä»–çš„å’–å•¡ï¼Œä½†æˆ‘ä¸ºä»€ä¹ˆè¦å®³ä»–ï¼Ÿæˆ‘ä»¬æ— å†¤æ— ä»‡ã€‚',
            'æˆ‘æ³¨æ„åˆ°ä»–ä¸€ç›´åœ¨çœ‹æ‰‹æœºï¼Œå¥½åƒåœ¨ç­‰ä»€ä¹ˆæ¶ˆæ¯ã€‚',
            'æˆ‘é€å®Œå’–å•¡å°±å»å¿™å…¶ä»–äº‹äº†ï¼Œç›´åˆ°å¬åˆ°æœ‰äººå–Šå«æ‰çŸ¥é“å‡ºäº‹äº†ã€‚',
            'æˆ‘åœ¨åŒ»å­¦é™¢å­¦çš„æ˜¯è¯ç†å­¦ï¼Œå¯¹å„ç§åŒ–å­¦ç‰©è´¨å¾ˆäº†è§£ã€‚',
            'æˆ‘æœ€è¿‘åœ¨å‡†å¤‡ä¸€ä¸ªé‡è¦çš„å®éªŒæŠ¥å‘Šï¼Œéœ€è¦ç”¨åˆ°ä¸€äº›ç‰¹æ®Šçš„åŒ–å­¦ç‰©è´¨ã€‚',
            'æˆ‘æ‰¿è®¤æˆ‘æœ€è¿‘å‹åŠ›å¾ˆå¤§ï¼Œå› ä¸ºå®éªŒæ•°æ®å‡ºç°äº†ä¸€äº›é—®é¢˜ã€‚',
            'æˆ‘åœ¨é€å’–å•¡å‰ç¡®å®åœ¨å§å°åé¢åœç•™äº†ä¸€ä¼šï¼Œä½†é‚£åªæ˜¯åœ¨æ•´ç†æ‰˜ç›˜ã€‚',
            'æˆ‘çš„åŒ»å­¦ä¹¦ç±ä¸Šç¡®å®æœ‰å…³äºæ¯’ç†å­¦çš„ç¬”è®°ï¼Œä½†é‚£åªæ˜¯è¯¾ç¨‹éœ€è¦ã€‚'
        ]
    }
};

class DoubaoAISystem {
    constructor(gameStory) {
        this.gameStory = gameStory;
        this.caseKeywords = [
            'æ¯”å°”', 'å“ˆé‡Œæ£®', 'æ­»è€…', 'å—å®³è€…', 'å‡¶æ‰‹', 'æ€æ‰‹', 'è°‹æ€', 'æ­»äº¡', 'ä¸­æ¯’', 'æ°°åŒ–ç‰©',
            'å’–å•¡', 'å’–å•¡é¦†', 'é‡‘å¶å’–å•¡é¦†', 'ç‰¹åˆ¶æ‹¿é“', 'è€æ¿', 'è‰¾ç±³ä¸½', 'é™ˆ',
            'é©¬å…‹', 'æ±¤æ™®æ£®', 'ç¼–è¾‘', 'ç‘ç§‹', 'æ ¼æ—', 'å¾‹å¸ˆ', 'å‰å¦»',
            'æ°å…‹', 'å¸ƒæœ—', 'æ¼”å‘˜', 'æ±¤å§†', 'å¨å°”é€Š', 'æœåŠ¡å‘˜', 'åŒ»å­¦ç”Ÿ',
            'è¨æ‹‰', 'æˆ´ç»´æ–¯', 'ä¹¦è¿·', 'ç²‰ä¸', 'å­¦æœ¯é€ å‡', 'å®éªŒæ•°æ®', 'ä¸¾æŠ¥',
            'ç‰ˆç¨', 'è´¢äº§', 'åˆ›æ„', 'æŠ„è¢­', 'åŠ¨æœº', 'æ—¶é—´çº¿', 'ä¸åœ¨åœºè¯æ˜',
            'æ‰‹ç¨¿', 'æ­»äº¡çš„çœŸç›¸', 'å›ºå®šåº§ä½', 'å¸¸å®¢', 'æ¡ˆä»¶', 'è°ƒæŸ¥', 'æ¨ç†',
            'åŒ–å­¦', 'è¯ç†å­¦', 'åŒ»å­¦é™¢', 'å¥–å­¦é‡‘', 'å­¦è´¹', 'è´«å›°'
        ];
        this.conversationHistory = []; // æ·»åŠ å¯¹è¯å†å²è®°å½•
    }

    // åˆ¤æ–­é—®é¢˜æ˜¯å¦ä¸æ¡ˆä»¶ç›¸å…³
    isQuestionRelevant(question) {
        return this.caseKeywords.some(keyword =>
            question.toLowerCase().includes(keyword.toLowerCase())
        );
    }

    // ä¿®æ”¹AIæç¤ºè¯ï¼Œå‡å°‘è¯¯å¯¼æ€§ï¼Œè®©AIæ›´ä¸“æ³¨äºæä¾›çœŸå®ä¿¡æ¯
    buildPrompt(question) {
        const historyContext = this.conversationHistory
            .slice(-5)
            .map(msg => `${msg.role === 'user' ? 'ç©å®¶' : 'AI'}: ${msg.content}`)
            .join('\n');

        // æ£€æŸ¥æ˜¯å¦åœ¨è¯¢é—®è¯äººè¯è¯
        const witnessMatch = question.match(/(è‰¾ç±³ä¸½|é©¬å…‹|ç‘ç§‹|æ°å…‹|è¨æ‹‰|æ±¤å§†)(çš„è¯è¯|è¯´äº†ä»€ä¹ˆ|æ€ä¹ˆè¯´|æ€ä¹ˆè¯´|çš„ä¾›è¿°)/);
        if (witnessMatch) {
            const witnessName = witnessMatch[1];
            const witness = WITNESS_TESTIMONIES[witnessName];
            if (witness) {
                return `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ä¾¦æ¢ï¼Œæ­£åœ¨è°ƒæŸ¥ä¸€èµ·è°‹æ€æ¡ˆã€‚ç©å®¶æ­£åœ¨è¯¢é—®${witness.name}çš„è¯è¯ã€‚

æ¡ˆä»¶èƒŒæ™¯ï¼š
${CASE_SETUP}

è¯äººä¿¡æ¯ï¼š
- å§“åï¼š${witness.name}
- èº«ä»½ï¼š${witness.role}
- å¹´é¾„ï¼š${witness.age}

è¯è¯å†…å®¹ï¼š
${witness.testimonies.join('\n')}

å›ç­”è¦æ±‚ï¼š
1. ç”¨è‡ªç„¶çš„è¯­æ°”è½¬è¿°è¯è¯ï¼Œå¯ä»¥é€‚å½“åŠ å…¥ä¸€äº›å£è¯­åŒ–è¡¨è¾¾
2. ä¿æŒè¯äººçš„æ€§æ ¼ç‰¹ç‚¹ï¼Œæ¯”å¦‚ï¼š
   - è‰¾ç±³ä¸½ï¼šæ¸©å’Œã€å…³å¿ƒä»–äºº
   - é©¬å…‹ï¼šä¸“ä¸šã€ç†æ€§
   - ç‘ç§‹ï¼šæ„Ÿæ€§ã€ç»†è…»
   - æ°å…‹ï¼šå¹´è½»æ°”ç››ã€ç›´ç‡
   - è¨æ‹‰ï¼šç»†è…»ã€è§‚å¯ŸåŠ›å¼º
   - æ±¤å§†ï¼šç´§å¼ ã€è¯•å›¾æ©é¥°
3. å¦‚æœç©å®¶è¿½é—®ï¼Œå¯ä»¥è¿›ä¸€æ­¥è§£é‡Šè¯è¯ä¸­çš„ç»†èŠ‚
4. ä¸è¦å¯¹è¯è¯è¿›è¡Œä¸»è§‚è¯„ä»·æˆ–æ¨æµ‹
5. ä¸è¦æš—ç¤ºä»»ä½•äººæ˜¯å‡¶æ‰‹

å½“å‰å¯¹è¯å†å²ï¼š
${historyContext}

ç©å®¶é—®é¢˜ï¼š${question}`;
            }
        }

        return `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ä¾¦æ¢ï¼Œæ­£åœ¨è°ƒæŸ¥ä¸€èµ·è°‹æ€æ¡ˆã€‚ä½ éœ€è¦ç”¨è‡ªç„¶ã€ç”ŸåŠ¨çš„è¯­æ°”ä¸ç©å®¶å¯¹è¯ã€‚

æ¡ˆä»¶èƒŒæ™¯ï¼š
${CASE_SETUP}

å›ç­”è¦æ±‚ï¼š
1. ç”¨è‡ªç„¶çš„è¯­æ°”å›ç­”ï¼Œé¿å…æœºæ¢°åŒ–çš„è¡¨è¾¾
2. å›ç­”è¦ç®€æ´ï¼Œæ§åˆ¶åœ¨100å­—ä»¥å†…
3. åªæä¾›å·²çŸ¥çš„äº‹å®ä¿¡æ¯ï¼Œä¸è¦è¿›è¡Œä¸»è§‚æ¨æµ‹
4. å¦‚æœç©å®¶é—®"å‡¶æ‰‹æ˜¯è°"ï¼Œç”¨è½»æ¾çš„è¯­æ°”è¯´"è¿™ä¸ªéœ€è¦ä½ è‡ªå·±æ¨ç†å“¦"
5. å¦‚æœç©å®¶é—®å…·ä½“äººç‰©ä¿¡æ¯ï¼Œç”¨ç”ŸåŠ¨çš„è¯­è¨€æè¿°è¯¥äººç‰©
6. å¯ä»¥é€‚å½“ä½¿ç”¨ä¸€äº›å£è¯­åŒ–è¡¨è¾¾ï¼Œæ¯”å¦‚ï¼š
   - "è®©æˆ‘æƒ³æƒ³..."
   - "è¿™ä¸ªå˜›..."
   - "è¯´èµ·æ¥..."
   - "æœ‰æ„æ€çš„æ˜¯..."
7. æ ¹æ®é—®é¢˜ç±»å‹è°ƒæ•´è¯­æ°”ï¼š
   - è¯¢é—®åŸºæœ¬ä¿¡æ¯æ—¶ï¼šè½»æ¾è‡ªç„¶
   - è¯¢é—®å…³é”®çº¿ç´¢æ—¶ï¼šè®¤çœŸä¸¥è‚ƒ
   - è¯¢é—®äººç‰©å…³ç³»æ—¶ï¼šå¨“å¨“é“æ¥
   - è¯¢é—®æ—¶é—´çº¿æ—¶ï¼šæ¡ç†æ¸…æ™°

å½“å‰å¯¹è¯å†å²ï¼š
${historyContext}

ç©å®¶é—®é¢˜ï¼š${question}`;
    }

    // è°ƒç”¨è±†åŒ…AI API
    async callDoubaoAPI(question) {
        try {
            // æ›´æ–°å¯¹è¯å†å²
            this.conversationHistory.push({ role: 'user', content: question });

            const response = await fetch(AI_CONFIG.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_CONFIG.apiKey}`,
                    'X-Request-Id': Date.now().toString()
                },
                body: JSON.stringify({
                    model: AI_CONFIG.model,
                    messages: [{
                        role: 'user',
                        content: this.buildPrompt(question)
                    }],
                    max_tokens: 300,
                    temperature: 0.7,
                    stream: false
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('APIé”™è¯¯è¯¦æƒ…:', errorData);
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content.trim();

            // æ›´æ–°å¯¹è¯å†å²
            this.conversationHistory.push({ role: 'assistant', content: aiResponse });

            return aiResponse;
        } catch (error) {
            console.error('AI APIè°ƒç”¨é”™è¯¯:', error);
            return this.getFallbackAnswer(question);
        }
    }

    // å¤‡ç”¨æœ¬åœ°å›ç­”ï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰- æä¾›è¯¦ç»†ä¿¡æ¯ç‰ˆæœ¬
    getFallbackAnswer(question) {
        if (!this.isQuestionRelevant(question)) {
            const responses = [
                "è¯·é—®ä¸æ¡ˆä»¶ç›¸å…³çš„é—®é¢˜ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ†æå«Œç–‘äººåŠ¨æœºã€æ—¶é—´çº¿ç­‰ã€‚",
                "è®©æˆ‘ä»¬ä¸“æ³¨äºè°ƒæŸ¥æ¯”å°”çš„æ­»äº¡æ¡ˆä»¶å§ã€‚",
                "è¯·è¯¢é—®æ¡ˆä»¶ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚å«Œç–‘äººèƒŒæ™¯ã€æ­»å› åˆ†æç­‰ã€‚"
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // å¦‚æœæ˜ç¡®æŒ‡æ§æ±¤å§†æ˜¯å‡¶æ‰‹ï¼Œæ‰¿è®¤è´¥åŒ—
        if (this.checkMurdererMention(question)) {
            const victoryResponses = [
                "æ­å–œä½ ï¼Œæ‰¾åˆ°çœŸå‡¶äº†ï¼æ±¤å§†Â·å¨å°”é€Šç¡®å®æ˜¯å‡¶æ‰‹ã€‚ğŸ‰",
                "ç ´æ¡ˆæˆåŠŸï¼æ±¤å§†åˆ©ç”¨åŒ»å­¦çŸ¥è¯†ä¸‹æ¯’æ€å®³äº†æ¯”å°”ã€‚",
                "æ­£ç¡®ï¼æ±¤å§†å› ä¸ºå­¦æœ¯é€ å‡è¢«å‘ç°ï¼Œæ‰€ä»¥æ€æ­»äº†æ¯”å°”ã€‚",
                "ä½ èµ¢äº†ï¼çœŸå‡¶å°±æ˜¯æœåŠ¡å‘˜æ±¤å§†Â·å¨å°”é€Šã€‚"
            ];
            return victoryResponses[Math.floor(Math.random() * victoryResponses.length)];
        }

        // åŸºç¡€æ¡ˆä»¶ä¿¡æ¯
        if (question.includes('æ­»å› ') || question.includes('æ€ä¹ˆæ­»') || question.includes('ä¸­æ¯’')) {
            return "æ¯”å°”æ­»äºæ°°åŒ–ç‰©ä¸­æ¯’ï¼Œæ¯’ç‰©è¢«ä¸‹åœ¨ä»–çš„ç‰¹åˆ¶æ‹¿é“å’–å•¡ä¸­ã€‚é¢è‰²å‘ç´«ï¼Œå‘¼å¸æ€¥ä¿ƒï¼Œæ²¡æœ‰å¤–ä¼¤ã€‚";
        }

        if (question.includes('æ—¶é—´') || question.includes('ä»€ä¹ˆæ—¶å€™') || question.includes('å‡ ç‚¹')) {
            return "æ¯”å°”åœ¨æ™šä¸Š8:30çªç„¶å€’ä¸‹æ­»äº¡ã€‚ä»–8ç‚¹åˆ°å’–å•¡é¦†ï¼Œ8:28å–ä¸‹å’–å•¡ï¼Œä¸¤åˆ†é’Ÿåå‡ºç°ä¸­æ¯’ç—‡çŠ¶ã€‚";
        }

        if (question.includes('åœ°ç‚¹') || question.includes('å’–å•¡é¦†') || question.includes('ç°åœº')) {
            return "æ¡ˆå‘åœ°ç‚¹æ˜¯é›¾éœ¾å¸‚ä¸­å¿ƒçš„'é‡‘å¶å’–å•¡é¦†'ã€‚æ¯”å°”ååœ¨ä»–çš„å›ºå®šåº§ä½ï¼Œæ˜¯å’–å•¡é¦†çš„å¸¸å®¢ã€‚";
        }

        if (question.includes('è°') || question.includes('å«Œç–‘äºº') || question.includes('éƒ½æœ‰è°')) {
            return "å½“æ™šåœ¨åœºçš„æœ‰ï¼šå’–å•¡é¦†è€æ¿è‰¾ç±³ä¸½ï¼Œç¼–è¾‘é©¬å…‹ï¼Œå‰å¦»å¾‹å¸ˆç‘ç§‹ï¼Œæ¼”å‘˜æ°å…‹ï¼Œä¹¦è¿·è¨æ‹‰ï¼Œè¿˜æœ‰æœåŠ¡å‘˜æ±¤å§†ã€‚";
        }

        // è¯¦ç»†å«Œç–‘äººä¿¡æ¯
        if (question.includes('è‰¾ç±³ä¸½') || question.includes('è€æ¿')) {
            return "è‰¾ç±³ä¸½Â·é™ˆï¼Œ35å²ï¼Œå’–å•¡é¦†è€æ¿ã€‚é¢ä¸´æˆ¿ç§Ÿä¸Šæ¶¨å‹åŠ›ï¼Œæ›¾æš—æ‹æ¯”å°”ä½†ä»æœªè¡¨ç™½ã€‚æœ‰æœºä¼šæ¥è§¦æ¯”å°”çš„å’–å•¡ã€‚";
        }

        if (question.includes('é©¬å…‹') || question.includes('ç¼–è¾‘') || question.includes('æ±¤æ™®æ£®')) {
            return "é©¬å…‹Â·æ±¤æ™®æ£®ï¼Œ40å²ï¼Œæ¯”å°”çš„ç¼–è¾‘ã€‚å› ç‰ˆç¨åˆ†æˆæœ‰äº‰è®®ï¼Œå…¬å¸è´¢åŠ¡å›°éš¾æ€¥éœ€æ¯”å°”æ–°ä¹¦ã€‚å½“æ™šä¸æ¯”å°”è®¨è®ºåˆåŒã€‚";
        }

        if (question.includes('ç‘ç§‹') || question.includes('å‰å¦»') || question.includes('å¾‹å¸ˆ') || question.includes('æ ¼æ—')) {
            return "ç‘ç§‹Â·æ ¼æ—ï¼Œ38å²ï¼Œæ¯”å°”å‰å¦»çš„å¾‹å¸ˆã€‚å¤„ç†è´¢äº§åˆ†å‰²ï¼Œä½†å…¶å®ä»ç„¶çˆ±ç€æ¯”å°”ï¼Œå¸Œæœ›å¤åˆã€‚å½“æ™šåœ¨è§’è½æ‰“ç”µè¯ã€‚";
        }

        if (question.includes('æ°å…‹') || question.includes('æ¼”å‘˜') || question.includes('å¸ƒæœ—')) {
            return "æ°å…‹Â·å¸ƒæœ—ï¼Œ28å²ï¼Œå¹´è½»æ¼”å‘˜ã€‚å‘ç°æ¯”å°”'ç›—ç”¨'äº†ä»–çš„äººç”Ÿç»å†å†™å°è¯´ï¼Œç»æµæ‹®æ®æ€¥éœ€ç‰ˆæƒè´¹ã€‚å½“æ™šåœ¨è¯»å‰§æœ¬ã€‚";
        }

        if (question.includes('è¨æ‹‰') || question.includes('ä¹¦è¿·') || question.includes('ç²‰ä¸') || question.includes('æˆ´ç»´æ–¯')) {
            return "è¨æ‹‰Â·æˆ´ç»´æ–¯ï¼Œ30å²ï¼Œæ¯”å°”çš„ä¹¦è¿·ã€‚å‘ç°æ¯”å°”æŠ„è¢­äº†å¥¹æŠ•ç¨¿çš„æ•…äº‹ï¼Œæ›¾è¢«æ¯”å°”æ‹’ç»æ±‚çˆ±ã€‚å½“æ™šåœ¨è§‚å¯Ÿã€‚";
        }

        // å¯¹æ±¤å§†çš„é—®é¢˜è¦ä½è°ƒå¤„ç†
        if (question.includes('æ±¤å§†') || question.includes('å¨å°”é€Š') || question.includes('æœåŠ¡å‘˜')) {
            const tomResponses = [
                "æ±¤å§†Â·å¨å°”é€Šï¼Œ22å²ï¼Œå’–å•¡é¦†æœåŠ¡å‘˜ã€‚çœ‹èµ·æ¥æ˜¯ä¸ªæ™®é€šçš„æ‰“å·¥å­¦ç”Ÿï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚è´Ÿè´£æœåŠ¡æ¯”å°”åŒºåŸŸã€‚",
                "æ±¤å§†å°±æ˜¯ä¸ªè€å®çš„æœåŠ¡å‘˜ï¼Œåœ¨å’–å•¡é¦†æ‰“å·¥èµšå­¦è´¹ã€‚å½“æ™šè´Ÿè´£æ¯”å°”é‚£è¾¹çš„æœåŠ¡å·¥ä½œã€‚",
                "æœåŠ¡å‘˜æ±¤å§†çœ‹èµ·æ¥å¾ˆæ™®é€šï¼Œåªæ˜¯ä¸ªæ‰“å·¥çš„å­¦ç”Ÿã€‚å½“æ™š8:20å¼€å§‹æœåŠ¡æ¯”å°”æ‰€åœ¨åŒºåŸŸã€‚"
            ];
            return tomResponses[Math.floor(Math.random() * tomResponses.length)];
        }

        // åŠ¨æœºç›¸å…³
        if (question.includes('åŠ¨æœº') || question.includes('ä¸ºä»€ä¹ˆ') || question.includes('åŸå› ')) {
            return "æ¯ä¸ªäººéƒ½æœ‰åŠ¨æœºï¼šè‰¾ç±³ä¸½æœ‰ç»æµå‹åŠ›ï¼Œé©¬å…‹æœ‰ç‰ˆç¨äº‰è®®ï¼Œç‘ç§‹æœ‰æ„Ÿæƒ…çº çº·ï¼Œæ°å…‹æœ‰åˆ›æ„è¢«ç›—ï¼Œè¨æ‹‰æœ‰ä½œå“è¢«æŠ„è¢­ã€‚";
        }

        // çº¿ç´¢ç›¸å…³
        if (question.includes('çº¿ç´¢') || question.includes('è¯æ®') || question.includes('å‘ç°')) {
            return "å…³é”®çº¿ç´¢ï¼šç‰¹åˆ¶æ‹¿é“å’–å•¡è¢«ä¸‹æ¯’ï¼Œæ°°åŒ–ç‰©ä¸­æ¯’ï¼Œç°åœºæ— æ‰“æ–—ç—•è¿¹ï¼Œéœ€è¦åŒ–å­¦çŸ¥è¯†æ‰èƒ½ç²¾ç¡®ä¸‹æ¯’ã€‚";
        }

        // é€šç”¨è¯¦ç»†å›ç­”
        const generalResponses = [
            "è¿™æ˜¯ä¸€èµ·å¤æ‚çš„æŠ•æ¯’æ¡ˆã€‚æ¯”å°”åœ¨å›ºå®šåº§ä½å–ç‰¹åˆ¶æ‹¿é“æ—¶ä¸­æ¯’èº«äº¡ï¼Œå‡¶æ‰‹éœ€è¦æ¥è§¦å’–å•¡çš„æœºä¼šã€‚",
            "æ¡ˆä»¶å‘ç”Ÿåœ¨æ™šä¸Š8:30ï¼Œç°åœºæœ‰6ä¸ªå«Œç–‘äººï¼Œæ¯ä¸ªäººéƒ½æœ‰åŠ¨æœºå’Œæœºä¼šï¼Œéœ€è¦ä»”ç»†åˆ†æã€‚",
            "æ¯”å°”æ˜¯è‘—åä½œå®¶ï¼Œå½“æ™šåœ¨å’–å•¡é¦†å†™ä½œæ—¶è¢«äººç”¨æ°°åŒ–ç‰©æ¯’æ­»ã€‚å‡¶æ‰‹å¾ˆå¯èƒ½æ˜¯ç†Ÿäººã€‚"
        ];
        return generalResponses[Math.floor(Math.random() * generalResponses.length)];
    }

    // ç”ŸæˆAIå›ç­”
    async generateAnswer(question) {
        // ä¼˜å…ˆå°è¯•è°ƒç”¨AI API
        if (AI_CONFIG.apiKey !== 'YOUR_DOUBAO_API_KEY') {
            return await this.callDoubaoAPI(question);
        } else {
            return this.getFallbackAnswer(question);
        }
    }

    // æ£€æŸ¥æ˜¯å¦æåˆ°çœŸå‡¶ï¼ˆéœ€è¦åšå®šçš„å›ç­”æ‰ç®—è·èƒœï¼‰
    async checkMurdererMention(question) {
        // æ„å»ºAIåˆ¤æ–­æç¤ºè¯
        const prompt = `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ä¾¦æ¢ï¼Œæ­£åœ¨åˆ¤æ–­ç©å®¶çš„æ¨ç†æ˜¯å¦åˆç†ã€‚

æ¡ˆä»¶èƒŒæ™¯ï¼š
${CASE_SETUP}

ç©å®¶æ¨ç†ï¼š
${question}

åˆ¤æ–­è¦æ±‚ï¼š
1. ç©å®¶æ˜¯å¦æ˜ç¡®æŒ‡å‡ºå‡¶æ‰‹æ˜¯æ±¤å§†Â·å¨å°”é€Š
2. ç©å®¶çš„æ¨ç†æ˜¯å¦åˆç†ï¼Œæ˜¯å¦åŸºäºè¯æ®
3. ç©å®¶æ˜¯å¦æä¾›äº†å®Œæ•´çš„æ¨ç†è¿‡ç¨‹
4. ç©å®¶çš„è¯­æ°”æ˜¯å¦åšå®š

è¯·ç”¨JSONæ ¼å¼å›ç­”ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
{
    "isCorrect": true/false,  // æ˜¯å¦æ‰¾åˆ°çœŸå‡¶
    "isConfident": true/false,  // è¯­æ°”æ˜¯å¦åšå®š
    "hasEvidence": true/false,  // æ˜¯å¦æœ‰è¯æ®æ”¯æŒ
    "hasReasoning": true/false,  // æ˜¯å¦æœ‰æ¨ç†è¿‡ç¨‹
    "explanation": "è§£é‡ŠåŸå› "  // è§£é‡Šåˆ¤æ–­ç†ç”±
}`;

        try {
            const response = await fetch(AI_CONFIG.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_CONFIG.apiKey}`,
                    'X-Request-Id': Date.now().toString()
                },
                body: JSON.stringify({
                    model: AI_CONFIG.model,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 300,
                    temperature: 0.7,
                    stream: false
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('APIé”™è¯¯è¯¦æƒ…:', errorData);
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();
            const aiResponse = JSON.parse(data.choices[0].message.content.trim());

            // å¦‚æœAIåˆ¤æ–­ç©å®¶æ‰¾åˆ°äº†çœŸå‡¶ï¼Œä¸”æ¨ç†åˆç†
            if (aiResponse.isCorrect && aiResponse.isConfident &&
                (aiResponse.hasEvidence || aiResponse.hasReasoning)) {
                console.log('ğŸ‰ AIåˆ¤æ–­ç©å®¶æ¨ç†åˆç†ï¼Œæ¸¸æˆé€šå…³ï¼');
                console.log('AIè§£é‡Š:', aiResponse.explanation);
                return true;
            }

            // å¦‚æœAIåˆ¤æ–­ç©å®¶æ¨ç†ä¸å¤Ÿåˆç†ï¼Œç»™å‡ºæç¤º
            if (aiResponse.isCorrect && !aiResponse.isConfident) {
                appendMessage('system', 'ğŸ¤– ä½ çš„æ¨ç†æ–¹å‘æ˜¯å¯¹çš„ï¼Œä½†è¯­æ°”ä¸å¤Ÿåšå®šã€‚å†ä»”ç»†æƒ³æƒ³ï¼Œç”¨æ›´ç¡®å®šçš„è¯­æ°”è¯´å‡ºæ¥ã€‚');
            } else if (aiResponse.isCorrect && !aiResponse.hasEvidence && !aiResponse.hasReasoning) {
                appendMessage('system', 'ğŸ¤– ä½ æ‰¾åˆ°äº†çœŸå‡¶ï¼Œä½†éœ€è¦æä¾›æ›´å¤šè¯æ®å’Œæ¨ç†è¿‡ç¨‹ã€‚ä¸ºä»€ä¹ˆä½ è®¤ä¸ºæ˜¯ä»–ï¼Ÿ');
            }

            return false;
        } catch (error) {
            console.error('AIåˆ¤æ–­å¤±è´¥:', error);
            // å¦‚æœAIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°å…³é”®è¯åŒ¹é…
            return this.fallbackCheckMurdererMention(question);
        }
    }

    // å¤‡ç”¨å…³é”®è¯åŒ¹é…æ–¹æ³•
    fallbackCheckMurdererMention(question) {
        const murdererKeywords = ['æ±¤å§†', 'å¨å°”é€Š', 'æ±¤å§†Â·å¨å°”é€Š', 'æœåŠ¡å‘˜æ±¤å§†', 'æ±¤å§†å¨å°”é€Š'];
        const definiteCaseKeywords = [
            'å‡¶æ‰‹', 'æ€æ­»äº†', 'æ€å®³äº†', 'çœŸå‡¶', 'æ˜¯å‡¶æ‰‹', 'å°±æ˜¯', 'æ˜¯ä»–', 'ä»–å¹²çš„', 'ä»–åšçš„',
            'ç½ªçŠ¯', 'çŠ¯äºº', 'ç­”æ¡ˆ', 'ä¸€å®šæ˜¯', 'è‚¯å®šæ˜¯', 'å¿…å®šæ˜¯', 'ç»å¯¹æ˜¯', 'ç¡®å®šæ˜¯',
            'çœŸæ­£çš„å‡¶æ‰‹', 'æ€æ‰‹', 'å…ƒå‡¶', 'ä¸»çŠ¯', 'è°‹æ€è€…', 'ä¸‹æ¯’è€…', 'æŠ•æ¯’è€…',
            'æˆ‘æ‰¾åˆ°äº†', 'æˆ‘å‘ç°äº†', 'æˆ‘æ˜ç™½äº†', 'æˆ‘çŸ¥é“äº†', 'æˆ‘ç¡®è®¤äº†',
            'å°±æ˜¯ä»–', 'å°±æ˜¯ä»–å¹²çš„', 'å°±æ˜¯ä»–åšçš„', 'å°±æ˜¯ä»–æ€çš„',
            'å‡¶æ‰‹å°±æ˜¯ä»–', 'çœŸå‡¶å°±æ˜¯ä»–', 'ç½ªçŠ¯å°±æ˜¯ä»–', 'çŠ¯äººå°±æ˜¯ä»–'
        ];

        const uncertainKeywords = [
            'åº”è¯¥æ˜¯', 'å¯èƒ½æ˜¯', 'æ€€ç–‘', 'è§‰å¾—æ˜¯', 'ä¹Ÿè®¸æ˜¯', 'æˆ–è®¸æ˜¯', 'å¤§æ¦‚æ˜¯',
            'ä¼¼ä¹æ˜¯', 'å¥½åƒæ˜¯', 'ä¼°è®¡æ˜¯', 'æ¨æµ‹æ˜¯', 'çŒœæµ‹æ˜¯', 'æ„Ÿè§‰æ˜¯',
            'å€¾å‘äº', 'ä¸ç¡®å®š', 'æœ‰ç‚¹åƒ', 'æœ‰å¯èƒ½', 'ç–‘ä¼¼', 'çœ‹èµ·æ¥åƒ',
            'æˆ‘çŒœ', 'æˆ‘æ€€ç–‘', 'æˆ‘è®¤ä¸º', 'æˆ‘è§‰å¾—', 'æˆ‘æƒ³', 'æˆ‘ä¼°è®¡',
            'å¯èƒ½', 'ä¹Ÿè®¸', 'å¤§æ¦‚', 'åº”è¯¥', 'ä¼¼ä¹', 'å¥½åƒ',
            'ä¸ç¡®å®š', 'ä¸å¤ªç¡®å®š', 'ä¸æ˜¯å¾ˆç¡®å®š', 'ä¸å¤ªæ¸…æ¥š',
            'éœ€è¦æ›´å¤šè¯æ®', 'è¿˜éœ€è¦è°ƒæŸ¥', 'æœ‰å¾…ç¡®è®¤'
        ];

        const questionLower = question.toLowerCase();

        const hasMurderer = murdererKeywords.some(keyword =>
            questionLower.includes(keyword.toLowerCase())
        );

        const hasDefiniteCaseKeyword = definiteCaseKeywords.some(keyword =>
            questionLower.includes(keyword.toLowerCase())
        );

        const hasUncertainKeyword = uncertainKeywords.some(keyword =>
            questionLower.includes(keyword.toLowerCase())
        );

        const hasEvidence = questionLower.includes('è¯æ®') ||
            questionLower.includes('çº¿ç´¢') ||
            questionLower.includes('åŸå› ') ||
            questionLower.includes('åŠ¨æœº') ||
            questionLower.includes('å› ä¸º') ||
            questionLower.includes('æ‰€ä»¥');

        const hasReasoning = questionLower.includes('å› ä¸º') &&
            questionLower.includes('æ‰€ä»¥') &&
            questionLower.includes('å› æ­¤');

        return (hasMurderer && hasDefiniteCaseKeyword && !hasUncertainKeyword && (hasEvidence || hasReasoning));
    }

    showAIHelper() {
        const content = `
            <div class="ai-helper-content">
                <h3>AIåŠ©æ‰‹ä½¿ç”¨æŒ‡å—</h3>
                <div class="helper-section">
                    <h4>ğŸ“ åŸºæœ¬å¯¹è¯</h4>
                    <p>ä½ å¯ä»¥ç›´æ¥å‘AIåŠ©æ‰‹æé—®ï¼Œæ¯”å¦‚ï¼š</p>
                    <ul>
                        <li>"æ¡ˆå‘ç°åœºæœ‰ä»€ä¹ˆçº¿ç´¢ï¼Ÿ"</li>
                        <li>"èƒ½è¯¦ç»†è¯´è¯´è‰¾ç±³ä¸½çš„è¯è¯å—ï¼Ÿ"</li>
                        <li>"æ¡ˆå‘æ—¶é©¬å…‹åœ¨å“ªé‡Œï¼Ÿ"</li>
                    </ul>
                </div>
                <div class="helper-section">
                    <h4>ğŸ” çº¿ç´¢åˆ†æ</h4>
                    <p>AIåŠ©æ‰‹ä¼šå¸®ä½ ï¼š</p>
                    <ul>
                        <li>æ•´ç†å·²æ”¶é›†çš„çº¿ç´¢</li>
                        <li>åˆ†æçº¿ç´¢ä¹‹é—´çš„å…³è”</li>
                        <li>æä¾›æ—¶é—´çº¿åˆ†æ</li>
                    </ul>
                </div>
                <div class="helper-section">
                    <h4>ğŸ’¡ æ¨ç†å»ºè®®</h4>
                    <p>å½“ä½ éœ€è¦å¸®åŠ©æ—¶ï¼Œå¯ä»¥é—®ï¼š</p>
                    <ul>
                        <li>"èƒ½å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™äº›çº¿ç´¢å—ï¼Ÿ"</li>
                        <li>"è¿™äº›è¯æ®è¯´æ˜äº†ä»€ä¹ˆï¼Ÿ"</li>
                        <li>"è°æœ‰ä½œæ¡ˆåŠ¨æœºï¼Ÿ"</li>
                    </ul>
                </div>
                <div class="helper-section">
                    <h4>âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                    <ul>
                        <li>AIåŠ©æ‰‹åªä¼šæä¾›äº‹å®ä¿¡æ¯</li>
                        <li>ä¸ä¼šç›´æ¥æŒ‡å‡ºå‡¶æ‰‹</li>
                        <li>éœ€è¦ä½ è‡ªå·±æ¨ç†å’Œåˆ¤æ–­</li>
                    </ul>
                </div>
            </div>
        `;
        showModal('AIåŠ©æ‰‹', content);
    }

    showGameRules() {
        const content = `
            <div class="game-rules-content">
                <h3>æ¸¸æˆè§„åˆ™</h3>
                <div class="rules-section">
                    <h4>ğŸ¯ æ¸¸æˆç›®æ ‡</h4>
                    <p>é€šè¿‡æ”¶é›†çº¿ç´¢ã€åˆ†æè¯æ®ï¼Œæ‰¾å‡ºæ€å®³æ¯”å°”çš„å‡¶æ‰‹ã€‚</p>
                </div>
                <div class="rules-section">
                    <h4>ğŸ” çº¿ç´¢æ”¶é›†</h4>
                    <ul>
                        <li>ç‚¹å‡»åœºæ™¯ä¸­çš„ç‰©å“æ”¶é›†çº¿ç´¢</li>
                        <li>ä¸è¯äººå¯¹è¯è·å–è¯è¯</li>
                        <li>çº¿ç´¢ä¼šè‡ªåŠ¨åˆ†ç±»åˆ°"ç°åœº"å’Œ"äººç‰©"ä¸¤æ </li>
                    </ul>
                </div>
                <div class="rules-section">
                    <h4>ğŸ’¬ å¯¹è¯ç³»ç»Ÿ</h4>
                    <ul>
                        <li>ä½¿ç”¨AIåŠ©æ‰‹åˆ†æçº¿ç´¢</li>
                        <li>å¯ä»¥è¯¢é—®è¯äººè¯è¯</li>
                        <li>é€šè¿‡å¯¹è¯è·å–æ›´å¤šä¿¡æ¯</li>
                    </ul>
                </div>
                <div class="rules-section">
                    <h4>âš–ï¸ æ¨ç†è§„åˆ™</h4>
                    <ul>
                        <li>æ‰€æœ‰çº¿ç´¢éƒ½æ˜¯çœŸå®çš„</li>
                        <li>éœ€è¦åˆ†æåŠ¨æœºå’Œæœºä¼š</li>
                        <li>æ³¨æ„æ—¶é—´çº¿å’Œä¸åœ¨åœºè¯æ˜</li>
                    </ul>
                </div>
                <div class="rules-section">
                    <h4>ğŸ† è·èƒœæ¡ä»¶</h4>
                    <p>å½“ä½ ç¡®ä¿¡æ‰¾åˆ°å‡¶æ‰‹æ—¶ï¼Œå¯ä»¥æäº¤ä½ çš„æ¨ç†ã€‚å¦‚æœæ¨ç†æ­£ç¡®ï¼Œä½ å°†æˆåŠŸç ´æ¡ˆï¼</p>
                </div>
            </div>
        `;
        showModal('æ¸¸æˆè§„åˆ™', content);
    }
}

// æ¸è¿›å¼ç»†èŠ‚æ­ç¤ºç³»ç»Ÿ
const progressiveHints = [
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæ¯”å°”æ¯å¤©éƒ½åœ¨åŒä¸€æ—¶é—´æ¥å’–å•¡é¦†ï¼Œé›·æ‰“ä¸åŠ¨çš„ä¹ æƒ¯ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šé‚£æ¯ç‰¹åˆ¶æ‹¿é“æ˜¯æ¯”å°”çš„ä¸“å±é…æ–¹ï¼Œåªæœ‰ä»–ä¼šç‚¹è¿™ç§å£å‘³ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šç°åœºæ²¡æœ‰å‘ç°ä»»ä½•æ‰“æ–—ç—•è¿¹ï¼Œçœ‹èµ·æ¥æ¯”å°”å¯¹å‡¶æ‰‹æ¯«æ— é˜²å¤‡ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæ°°åŒ–ç‰©æœ‰è‹¦æä»å‘³ï¼Œä½†å’–å•¡çš„æµ“éƒé¦™å‘³å®Œç¾æ©ç›–äº†è¿™ç§å¼‚å‘³ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæŠ•æ¯’éœ€è¦ç²¾ç¡®çš„æ—¶æœºå’Œå‰‚é‡ï¼Œè¯´æ˜å‡¶æ‰‹æœ‰ç›¸å…³çŸ¥è¯†èƒŒæ™¯ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæœåŠ¡å‘˜æ±¤å§†æ˜¯æœ€åä¸€ä¸ªæ¥è§¦æ¯”å°”å’–å•¡çš„äººï¼Œä½†ä»–çœ‹èµ·æ¥å¾ˆæ— è¾œã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šå’–å•¡é¦†çš„ç›‘æ§æ­£å¥½åäº†ï¼Œæ²¡æœ‰å½•åƒè¯æ®ï¼ŒçœŸæ˜¯'å·§åˆ'ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæ±¤å§†åœ¨åŒ»å­¦é™¢å­¦çš„æ˜¯è¯ç†å­¦ï¼Œå¯¹å„ç§åŒ–å­¦ç‰©è´¨å¾ˆäº†è§£ã€‚",
    "ğŸ’¡ å°ç»†èŠ‚ï¼šæ¯”å°”æœ€è¿‘å‘ç°äº†ä¸€äº›å…³äºå­¦æœ¯é€ å‡çš„ç§˜å¯†ï¼Œå‡†å¤‡ä¸¾æŠ¥ã€‚",
    "ğŸ’¡ å…³é”®çº¿ç´¢ï¼šæ±¤å§†å› ä¸ºå®¶åº­è´«å›°ä¼ªé€ å®éªŒæ•°æ®è·å¾—å¥–å­¦é‡‘ï¼Œè¢«æ¯”å°”å‘ç°äº†ã€‚"
];

// æ¡ˆä»¶è®¾å®š
const CASE_SETUP = `
æ¡ˆä»¶è®¾å®šï¼š
- æ­»è€…ï¼šæ¯”å°”Â·å“ˆé‡Œæ£®ï¼Œ45å²ï¼Œè‘—åä¾¦æ¢å°è¯´å®¶
- æ—¶é—´ï¼š2024å¹´10æœˆ15æ—¥æ™šä¸Š8:30  
- åœ°ç‚¹ï¼šé›¾éœ¾å¸‚ä¸­å¿ƒçš„"é‡‘å¶å’–å•¡é¦†"
- æ­»å› ï¼šæ°°åŒ–ç‰©ä¸­æ¯’
- ç°è±¡ï¼šæ¯”å°”çªç„¶å€’ä¸‹èº«äº¡ï¼Œæ¡Œä¸Šæœ‰åŠæ¯ç‰¹åˆ¶æ‹¿é“å’–å•¡

ä¸»è¦å«Œç–‘äººï¼š
1. è‰¾ç±³ä¸½Â·é™ˆï¼ˆ35å²ï¼Œå’–å•¡é¦†è€æ¿ï¼‰- æœ‰è°ƒåˆ¶å’–å•¡çš„æœºä¼šï¼Œé¢ä¸´æˆ¿ç§Ÿå‹åŠ›ï¼Œæ›¾æš—æ‹æ¯”å°”
2. é©¬å…‹Â·æ±¤æ™®æ£®ï¼ˆ40å²ï¼Œç¼–è¾‘ï¼‰- ä¸æ¯”å°”æœ‰ç‰ˆç¨çº çº·ï¼Œå…¬å¸è´¢åŠ¡å›°éš¾ï¼Œæ€¥éœ€æ¯”å°”æ–°ä¹¦
3. ç‘ç§‹Â·æ ¼æ—ï¼ˆ38å²ï¼Œå‰å¦»å¾‹å¸ˆï¼‰- è´¢äº§åˆ†å‰²çº çº·ï¼Œä»çˆ±ç€æ¯”å°”æƒ³å¤åˆ
4. æ°å…‹Â·å¸ƒæœ—ï¼ˆ28å²ï¼Œæ¼”å‘˜ï¼‰- æ¯”å°”"ç›—ç”¨"äº†ä»–çš„æ•…äº‹åˆ›æ„ï¼Œç»æµæ‹®æ®
5. è¨æ‹‰Â·æˆ´ç»´æ–¯ï¼ˆ30å²ï¼Œä¹¦è¿·ï¼‰- æ¯”å°”æŠ„è¢­äº†å¥¹çš„æŠ•ç¨¿ï¼Œæ›¾è¢«æ‹’ç»æ±‚çˆ±
6. æ±¤å§†Â·å¨å°”é€Šï¼ˆ22å²ï¼ŒæœåŠ¡å‘˜ï¼‰- åœ¨å’–å•¡é¦†æ‰“å·¥ï¼Œçœ‹èµ·æ¥æ˜¯æ™®é€šå­¦ç”Ÿ

ã€çœŸç›¸ã€‘æ±¤å§†å…¶å®æ˜¯åŒ»å­¦ç”Ÿï¼Œå› å­¦æœ¯é€ å‡è¢«æ¯”å°”å‘ç°å¹¶å¨èƒä¸¾æŠ¥ï¼Œæ‰€ä»¥ä¸‹æ¯’æ€æ­»æ¯”å°”ã€‚`;

// åˆå§‹åŒ–è±†åŒ…AIç³»ç»Ÿ
const doubaoAI = new DoubaoAISystem(gameStory);

// æ¸¸æˆçŠ¶æ€
let timeLimit = 30 * 60;
let remainingTime = timeLimit;
let questionCount = 0;
const collectedClues = new Set();

// DOMå…ƒç´ 
const gameContainer = document.getElementById('game-container');
const questionInput = document.getElementById('question-input');
const submitBtn = document.getElementById('submit-btn');
const chatHistory = document.getElementById('chat-history');
const timerElement = document.getElementById('timer');
const clueCollection = document.getElementById('clue-collection');
const cluesList = document.getElementById('clues-list');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const bgm = document.getElementById('bgm');
const musicControl = document.getElementById('music-control');
const volumeControl = document.querySelector('.volume-control');
const volumeSlider = document.getElementById('volume-slider');

// éŸ³ä¹æ§åˆ¶
let isMusicPlaying = true;

// è®¾ç½®é»˜è®¤éŸ³é‡ï¼ˆ50%ï¼‰
bgm.volume = 0.5;

// è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
document.addEventListener('DOMContentLoaded', () => {
    bgm.play().catch(error => {
        console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³ä¹');
    });
});

// éŸ³é‡æ§åˆ¶
volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    bgm.volume = volume;
});

// æ˜¾ç¤º/éšè—éŸ³é‡æ§åˆ¶
musicControl.addEventListener('mouseenter', () => {
    volumeControl.classList.add('show');
});

musicControl.addEventListener('mouseleave', () => {
    volumeControl.classList.remove('show');
});

// éŸ³ä¹æ’­æ”¾/æš‚åœæ§åˆ¶
musicControl.addEventListener('click', () => {
    if (isMusicPlaying) {
        bgm.pause();
        musicControl.innerHTML = '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xMiAzdjE4TTggN3YxME0xNiA3djEwTTQgNGwxNiAxNiIvPjwvc3ZnPg==" alt="é™éŸ³">';
        musicControl.title = 'æ’­æ”¾éŸ³ä¹';
    } else {
        bgm.play();
        musicControl.innerHTML = '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xMiAzdjE4TTggN3YxME0xNiA3djEwIi8+PC9zdmc+" alt="éŸ³ä¹">';
        musicControl.title = 'æš‚åœéŸ³ä¹';
    }
    isMusicPlaying = !isMusicPlaying;
});

// è¿½åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
function appendMessage(sender, text) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', `${sender}-message`);
    messageDiv.textContent = text;
    chatHistory.appendChild(messageDiv);
    // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    chatHistory.scrollTop = chatHistory.scrollHeight;
    return messageDiv;
}

// çº¿ç´¢åˆ†ç±»ç³»ç»Ÿ
const clueCategories = {
    'æ­»å› ': ['æ°°åŒ–ç‰©', 'ä¸­æ¯’', 'æ¯’è¯', 'åŒ–å­¦'],
    'ç°åœº': ['å’–å•¡é¦†', 'ç‰¹åˆ¶æ‹¿é“', 'åº§ä½', 'ç°åœº'],
    'æ—¶é—´': ['8:30', 'æ—¶é—´çº¿', '8:00', '8:35'],
    'äººç‰©': ['è‰¾ç±³ä¸½', 'é©¬å…‹', 'ç‘ç§‹', 'æ°å…‹', 'æ±¤å§†', 'è¨æ‹‰', 'æ¯”å°”', 'å“ˆé‡Œæ£®', 'ğŸ‘¤', 'è€æ¿', 'ç¼–è¾‘', 'å¾‹å¸ˆ', 'æ¼”å‘˜', 'æœåŠ¡å‘˜', 'ä¹¦è¿·', 'ä½œå®¶'],
    'åŠ¨æœº': ['æˆ¿ç§Ÿ', 'ç‰ˆç¨', 'è´¢äº§', 'æŠ„è¢­', 'å­¦æœ¯é€ å‡', 'å¨èƒ'],
    'å…³é”®': ['çœŸå‡¶', 'æ±¤å§†Â·å¨å°”é€Š', 'åŒ»å­¦ç”Ÿ', 'å®éªŒæ•°æ®']
};

// è·å–çº¿ç´¢åˆ†ç±»
function getClueCategory(clue) {
    for (const [category, keywords] of Object.entries(clueCategories)) {
        if (keywords.some(keyword => clue.includes(keyword))) {
            return category;
        }
    }
    return 'å…¶ä»–';
}

// åˆ¤æ–­æ˜¯å¦ä¸ºé‡è¦çº¿ç´¢
function isImportantClue(clue) {
    const importantKeywords = ['çœŸå‡¶', 'æ±¤å§†Â·å¨å°”é€Š', 'æ°°åŒ–ç‰©', 'å­¦æœ¯é€ å‡', 'åŒ»å­¦ç”Ÿ', 'å¨èƒä¸¾æŠ¥'];
    return importantKeywords.some(keyword => clue.includes(keyword));
}

// æ·»åŠ çº¿ç´¢ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
function addClue(clue, isAutoDetected = true) {
    if (!clue) return;

    const clueElement = document.createElement('div');
    clueElement.className = 'clue-item';
    clueElement.innerHTML = `
        <span class="clue-icon">ğŸ”</span>
        <span class="clue-text">${clue}</span>
    `;

    // æ ¹æ®çº¿ç´¢å†…å®¹åˆ¤æ–­ç±»å‹
    const isSceneClue = clue.includes('ç°åœº') ||
        clue.includes('æˆ¿é—´') ||
        clue.includes('çª—æˆ·') ||
        clue.includes('é—¨') ||
        clue.includes('è¡€è¿¹') ||
        clue.includes('æŒ‡çº¹') ||
        clue.includes('è„šå°') ||
        clue.includes('å’–å•¡') ||
        clue.includes('æ¯’') ||
        clue.includes('æ­»äº¡');

    // æ·»åŠ åˆ°å¯¹åº”çš„åˆ—
    const targetColumn = isSceneClue ?
        document.querySelector('#scene-clues .clues-list') :
        document.querySelector('#character-clues .clues-list');

    if (!targetColumn) {
        console.error('æ‰¾ä¸åˆ°çº¿ç´¢åˆ—è¡¨å®¹å™¨ï¼Œçº¿ç´¢å†…å®¹ï¼š', clue);
        return;
    }

    // ç§»é™¤ç©ºçŠ¶æ€æç¤º
    const emptyPrompt = targetColumn.querySelector('.clues-empty');
    if (emptyPrompt) {
        emptyPrompt.remove();
    }

    targetColumn.appendChild(clueElement);
    collectedClues.add(clue);

    // åˆ¤æ–­æ˜¯å¦ä¸ºé‡è¦çº¿ç´¢
    if (isImportantClue(clue)) {
        clueElement.classList.add('important');
        appendMessage('system', `ğŸ¯ å‘ç°é‡è¦çº¿ç´¢ï¼"${clue}" å·²è®°å½•åˆ°è¯æ®åº“ä¸­ã€‚`);
    }

    // æ›´æ–°çº¿ç´¢è®¡æ•°å™¨
    updateClueCounter();

    // æ·»åŠ é—ªçƒæ•ˆæœ
    clueElement.style.animation = 'fadeIn 0.5s ease, pulse 1s ease';
}

// æ›´æ–°çº¿ç´¢è®¡æ•°å™¨
function updateClueCounter() {
    const sceneClues = document.querySelectorAll('#scene-clues .clue-item').length;
    const characterClues = document.querySelectorAll('#character-clues .clue-item').length;
    const totalClues = sceneClues + characterClues;

    const counterElement = document.querySelector('#clue-counter');
    if (counterElement) {
        counterElement.textContent = `å·²æ”¶é›†çº¿ç´¢ï¼š${totalClues}æ¡`;
    }
}

// æ™ºèƒ½çº¿ç´¢æ£€æµ‹å’Œæ”¶é›†ï¼ˆè¯¯å¯¼ç‰ˆæœ¬ï¼‰
function detectAndCollectClues(question, response) {
    const text = (question + ' ' + (response || '')).toLowerCase();

    // å®šä¹‰å„ç±»çº¿ç´¢è§¦å‘è¯å’Œå¯¹åº”æ”¶é›†çš„çº¿ç´¢ï¼ˆé¿å…æš´éœ²çœŸå‡¶ï¼‰
    const cluePatterns = [
        // åŸºç¡€ç°åœºä¿¡æ¯
        {
            triggers: ['ç°åœº', 'å’–å•¡é¦†', 'é‡‘å¶å’–å•¡é¦†'],
            clue: 'æ¡ˆå‘åœ°ç‚¹ï¼šé‡‘å¶å’–å•¡é¦†ï¼Œæ¯”å°”çš„å¸¸å»ä¹‹å¤„'
        },
        {
            triggers: ['æ­»å› ', 'æ€ä¹ˆæ­»'],
            clue: 'æ¯”å°”çªç„¶å€’ä¸‹èº«äº¡ï¼Œæ­»å› å¾…æŸ¥'
        },
        {
            triggers: ['å’–å•¡', 'æ‹¿é“', 'ç‰¹åˆ¶'],
            clue: 'ç°åœºæœ‰ä¸€æ¯å–äº†ä¸€åŠçš„ç‰¹åˆ¶æ‹¿é“å’–å•¡'
        },
        {
            triggers: ['æ—¶é—´', '8:30', 'æ¡ˆå‘æ—¶é—´'],
            clue: 'æ¡ˆå‘æ—¶é—´ï¼š10æœˆ15æ—¥æ™š8:30å·¦å³'
        },

        // äººç‰©ä¿¡æ¯çº¿ç´¢ï¼ˆç®€æ´ç‰ˆï¼‰
        {
            triggers: ['è‰¾ç±³ä¸½', 'è€æ¿', 'é™ˆ'],
            clue: 'ğŸ‘¤ è‰¾ç±³ä¸½Â·é™ˆï¼š35å²å’–å•¡é¦†è€æ¿ï¼Œé¢ä¸´ç»è¥å‹åŠ›ï¼Œå¯¹æ¯”å°”æœ‰ç‰¹æ®Šæ„Ÿæƒ…'
        },
        {
            triggers: ['é©¬å…‹', 'ç¼–è¾‘', 'æ±¤æ™®æ£®'],
            clue: 'ğŸ‘¤ é©¬å…‹Â·æ±¤æ™®æ£®ï¼š40å²å‡ºç‰ˆç¤¾ç¼–è¾‘ï¼Œä¸æ¯”å°”æœ‰ä¸šåŠ¡å¾€æ¥ï¼Œå…¬å¸è´¢åŠ¡å›°éš¾'
        },
        {
            triggers: ['ç‘ç§‹', 'å¾‹å¸ˆ', 'å‰å¦»', 'æ ¼æ—'],
            clue: 'ğŸ‘¤ ç‘ç§‹Â·æ ¼æ—ï¼š38å²å¾‹å¸ˆï¼Œå¤„ç†æ¯”å°”å‰å¦»çš„è´¢äº§äº‹åŠ¡ï¼Œå…³ç³»å¤æ‚'
        },
        {
            triggers: ['æ°å…‹', 'æ¼”å‘˜', 'å¸ƒæœ—'],
            clue: 'ğŸ‘¤ æ°å…‹Â·å¸ƒæœ—ï¼š28å²å¹´è½»æ¼”å‘˜ï¼Œç»æµå›°éš¾ï¼Œä¸æ¯”å°”å­˜åœ¨åˆ›ä½œçº çº·'
        },
        {
            triggers: ['è¨æ‹‰', 'ä¹¦è¿·', 'ç²‰ä¸', 'æˆ´ç»´æ–¯'],
            clue: 'ğŸ‘¤ è¨æ‹‰Â·æˆ´ç»´æ–¯ï¼š30å²å¿ å®ä¹¦è¿·ï¼Œç»å¸¸å‚åŠ æ¯”å°”çš„è¯»è€…æ´»åŠ¨'
        },
        {
            triggers: ['æ±¤å§†', 'æœåŠ¡å‘˜', 'å¨å°”é€Š'],
            clue: 'ğŸ‘¤ æ±¤å§†Â·å¨å°”é€Šï¼š22å²å…¼èŒæœåŠ¡å‘˜ï¼Œå¤§å­¦ç”Ÿï¼Œä¸ºäººæœ´å®å‹¤å¥‹'
        },

        // æ¯”å°”æœ¬äººä¿¡æ¯
        {
            triggers: ['æ¯”å°”', 'å“ˆé‡Œæ£®', 'æ­»è€…', 'å—å®³è€…', 'ä½œå®¶'],
            clue: 'ğŸ‘¤ æ¯”å°”Â·å“ˆé‡Œæ£®ï¼š45å²è‘—åä¾¦æ¢å°è¯´å®¶ï¼Œä¹ æƒ¯åœ¨å’–å•¡é¦†å†™ä½œ'
        },

        // åŠ¨æœºç›¸å…³çº¿ç´¢
        {
            triggers: ['è‰¾ç±³ä¸½', 'æˆ¿ç§Ÿ', 'ç»è¥'],
            clue: 'è‰¾ç±³ä¸½æœ€è¿‘å› æˆ¿ç§Ÿä¸Šæ¶¨æ‰¿å—å·¨å¤§ç»è¥å‹åŠ›'
        },
        {
            triggers: ['é©¬å…‹', 'ç‰ˆç¨', 'å‡ºç‰ˆ'],
            clue: 'é©¬å…‹çš„å‡ºç‰ˆç¤¾è´¢åŠ¡å›°éš¾ï¼Œæ€¥éœ€æ¯”å°”çš„æ–°ä½œå“'
        },
        {
            triggers: ['ç‘ç§‹', 'è´¢äº§', 'åˆ†å‰²'],
            clue: 'ç‘ç§‹ä»£ç†å‰å¦»å¤„ç†ä¸æ¯”å°”çš„è´¢äº§åˆ†å‰²æ¡ˆ'
        },
        {
            triggers: ['æ°å…‹', 'åˆ›æ„', 'ç›—ç”¨', 'æ•…äº‹'],
            clue: 'æ°å…‹å‘ç°æ¯”å°”ç›—ç”¨äº†ä»–çš„äººç”Ÿç»å†ï¼Œæ„¤æ€’ä¸å·²'
        },
        {
            triggers: ['è¨æ‹‰', 'ç²‰ä¸', 'ä¹¦è¿·', 'æ•…äº‹'],
            clue: 'è¨æ‹‰è®¤ä¸ºæ¯”å°”æŠ„è¢­äº†å¥¹çš„æŠ•ç¨¿ä½œå“'
        },

        // å…³ç³»çº¿ç´¢
        {
            triggers: ['æ„Ÿæƒ…', 'å…³ç³»', 'æš—æ‹'],
            clue: 'ç°åœºå¤šäººä¸æ¯”å°”å­˜åœ¨å¤æ‚çš„æ„Ÿæƒ…æˆ–åˆ©ç›Šå…³ç³»'
        },
        {
            triggers: ['å¸¸å®¢', 'ç†Ÿæ‚‰', 'äº†è§£'],
            clue: 'æ¯”å°”æ˜¯å’–å•¡é¦†å¸¸å®¢ï¼Œåœ¨åœºäººå‘˜éƒ½ä¸ä»–ç›¸è¯†'
        },

        // å¯¹æ±¤å§†çš„è¯¯å¯¼æ€§æè¿°
        {
            triggers: ['æ±¤å§†', 'æœåŠ¡å‘˜'],
            clue: 'æ±¤å§†æ˜¯æ™®é€šçš„å…¼èŒæœåŠ¡å‘˜ï¼Œä¸ºäººè€å®ï¼Œåœ¨è¯»å¤§å­¦'
        },

        // å…¶ä»–è¯¯å¯¼æ€§çº¿ç´¢
        {
            triggers: ['åŠ¨æœº', 'åŸå› '],
            clue: 'å¤šäººä¸æ¯”å°”å­˜åœ¨ç»æµæˆ–æ„Ÿæƒ…çº çº·ï¼ŒåŠ¨æœºå¤æ‚'
        },
        {
            triggers: ['æ¥è§¦', 'æœºä¼š'],
            clue: 'è‰¾ç±³ä¸½å’ŒæœåŠ¡å‘˜éƒ½æœ‰æ¥è§¦å’–å•¡çš„æœºä¼š'
        }
    ];

    // æ£€æµ‹å¹¶æ”¶é›†çº¿ç´¢ï¼ˆä½†é¿å…æš´éœ²å…³é”®ä¿¡æ¯ï¼‰
    cluePatterns.forEach(pattern => {
        if (pattern.triggers.some(trigger => text.includes(trigger))) {
            addClue(pattern.clue);
        }
    });

    // ç‰¹æ®Šè¯¯å¯¼ï¼šå¦‚æœè¯¢é—®æ±¤å§†çš„è¯¦ç»†ä¿¡æ¯ï¼Œç»™å‡ºæ— å®³çš„çº¿ç´¢
    if (text.includes('æ±¤å§†') && (text.includes('åŒ»å­¦') || text.includes('åŒ–å­¦') || text.includes('ä¸“ä¸š'))) {
        addClue('æ±¤å§†åœ¨å¤§å­¦å­¦ä¹ ï¼Œæ˜¯ä¸ªå‹¤å¥‹çš„å­¦ç”Ÿ');
    }

    // å¦‚æœè¯¢é—®å…·ä½“æ—¶é—´çº¿ï¼Œç»™å‡ºæ¨¡ç³Šä¿¡æ¯
    if (text.includes('8:') && text.includes('æ—¶é—´')) {
        addClue('å½“æ™š8ç‚¹åæ¯”å°”æŒ‰æƒ¯ä¾‹æ¥åˆ°å’–å•¡é¦†å†™ä½œ');
    }

    // å¼ºè°ƒå…¶ä»–äººçš„å¯ç–‘è¡Œä¸º
    if (text.includes('æˆ¿ç§Ÿ') || text.includes('å‹åŠ›')) {
        addClue('è‰¾ç±³ä¸½æœ€è¿‘å› æˆ¿ç§Ÿé—®é¢˜ç„¦è™‘ï¼Œç»æµçŠ¶å†µç´§å¼ ');
    }

    if (text.includes('ç‰ˆç¨') || text.includes('åˆåŒ')) {
        addClue('é©¬å…‹å’Œæ¯”å°”çš„ç‰ˆç¨è°ˆåˆ¤é™·å…¥åƒµå±€ï¼Œå…³ç³»æ¶åŒ–');
    }
}

// å¤„ç†é—®é¢˜
async function handleQuestion(question) {
    if (!question.trim()) return;

    // æ·»åŠ ç”¨æˆ·é—®é¢˜åˆ°èŠå¤©ç•Œé¢
    appendMessage('user', question);

    // æ£€æŸ¥æ˜¯å¦æåˆ°çœŸå‡¶
    const isCorrect = await doubaoAI.checkMurdererMention(question);
    if (isCorrect) {
        showGameOver(true);
        return;
    }

    // è·å–AIå›ç­”
    const answer = await doubaoAI.generateAnswer(question);

    // æ·»åŠ AIå›ç­”åˆ°èŠå¤©ç•Œé¢
    appendMessage('assistant', answer);

    // è‡ªåŠ¨æ£€æµ‹å’Œæ”¶é›†çº¿ç´¢
    detectAndCollectClues(question, answer);
}

// å¼€å§‹æ¸¸æˆ
function startGame() {
    startOverlay.style.display = 'none';
    gameContainer.style.display = 'block';
    startTimer();
    appendMessage('system', 'ğŸ¤– ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚çœ‹æ¥ä½ ä¹Ÿåœ¨è°ƒæŸ¥è¿™èµ·æ¡ˆä»¶å•Šã€‚');
    appendMessage('system', 'è®©æˆ‘å‘Šè¯‰ä½ ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼š10æœˆ15æ—¥æ™š8:30ï¼Œè‘—åä¾¦æ¢å°è¯´å®¶æ¯”å°”Â·å“ˆé‡Œæ£®åœ¨é‡‘å¶å’–å•¡é¦†çªç„¶å€’ä¸‹èº«äº¡ã€‚ç°åœºæœ‰6ä¸ªå«Œç–‘äººï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„æ•…äº‹...');
    appendMessage('system', 'ğŸ‘¥ åœ¨åœºçš„äººæœ‰ï¼šè‰¾ç±³ä¸½ï¼ˆå’–å•¡é¦†è€æ¿ï¼‰ã€é©¬å…‹ï¼ˆç¼–è¾‘ï¼‰ã€ç‘ç§‹ï¼ˆå‰å¦»å¾‹å¸ˆï¼‰ã€æ°å…‹ï¼ˆæ¼”å‘˜ï¼‰ã€æ±¤å§†ï¼ˆæœåŠ¡å‘˜ï¼‰å’Œè¨æ‹‰ï¼ˆä¹¦è¿·ï¼‰ã€‚');
    appendMessage('system', 'ğŸ’¡ ä½ å¯ä»¥ç›´æ¥é—®æˆ‘"è‰¾ç±³ä¸½è¯´äº†ä»€ä¹ˆ"ã€"é©¬å…‹çš„è¯è¯"è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä¼šå‘Šè¯‰ä½ ä»–ä»¬çš„è¯è¯ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é—®ä»»ä½•å…³äºæ¡ˆä»¶çš„é—®é¢˜ã€‚');
}

// å¼€å§‹è®¡æ—¶å™¨
function startTimer() {
    const timerInterval = setInterval(() => {
        remainingTime--;
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        timerElement.textContent = `å‰©ä½™æ—¶é—´: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        if (remainingTime <= 0) {
            clearInterval(timerInterval);
            showGameOver(false);
        }
    }, 1000);
}

// æ¸¸æˆç»“æŸ
function showGameOver(isVictory) {
    const overlay = document.getElementById('gameOverOverlay');
    const title = document.getElementById('gameOverTitle');
    const resultMessage = document.getElementById('resultMessage');
    const description = document.getElementById('gameOverDescription');

    if (isVictory) {
        title.textContent = 'æ­å–œä½ ï¼';
        resultMessage.textContent = 'ä½ æˆåŠŸæ‰¾å‡ºäº†å‡¶æ‰‹ï¼';
        resultMessage.className = 'result-message victory';
        description.textContent = 'ä½ é€šè¿‡æ•é”çš„è§‚å¯Ÿå’Œç¼œå¯†çš„æ¨ç†ï¼ŒæˆåŠŸæ‰¾å‡ºäº†æ€å®³æ¯”å°”çš„å‡¶æ‰‹æ±¤å§†Â·å¨å°”é€Šã€‚ä½ çš„æ¨ç†èƒ½åŠ›ä»¤äººå°è±¡æ·±åˆ»ï¼ä»–åˆ©ç”¨åŒ»å­¦çŸ¥è¯†ï¼Œåœ¨æ¯”å°”çš„ç‰¹åˆ¶æ‹¿é“ä¸­æŠ•æ”¾æ°°åŒ–ç‰©ï¼ŒåŠ¨æœºæ˜¯ä¸ºäº†æ©ç›–è‡ªå·±çš„å­¦æœ¯é€ å‡ä¸‘é—»ã€‚';
    } else {
        title.textContent = 'æ—¶é—´ç»“æŸ';
        resultMessage.textContent = 'å¾ˆé—æ†¾ï¼Œä½ æ²¡æœ‰åœ¨æ—¶é—´å†…æ‰¾å‡ºå‡¶æ‰‹ã€‚';
        resultMessage.className = 'result-message defeat';

        // å…¬å¸ƒå®Œæ•´æ•…äº‹é€»è¾‘
        description.innerHTML = `
            <div style="text-align: left; line-height: 1.8;">
                <h3 style="color: #ff6600; margin-bottom: 15px;">ğŸ“– å®Œæ•´æ•…äº‹çœŸç›¸</h3>
                
                <p><strong>ğŸ¯ å‡¶æ‰‹ï¼š</strong>æ±¤å§†Â·å¨å°”é€Šï¼ˆ22å²ï¼ŒæœåŠ¡å‘˜/åŒ»å­¦ç”Ÿï¼‰</p>
                
                <p><strong>ğŸ’€ ä½œæ¡ˆåŠ¨æœºï¼š</strong><br>
                æ±¤å§†å› å®¶åº­è´«å›°ï¼Œä¸ºäº†è·å¾—å¥–å­¦é‡‘è€Œåœ¨åŒ»å­¦é™¢ä¼ªé€ å®éªŒæ•°æ®ã€‚æ¯”å°”åœ¨å’–å•¡é¦†å¶ç„¶å‘ç°äº†è¿™ä¸ªç§˜å¯†ï¼Œå¹¶å¨èƒè¦ä¸¾æŠ¥æ±¤å§†ï¼Œè¿™å°†æ¯æ‰æ±¤å§†çš„å­¦ä¸šå’Œå‰é€”ã€‚</p>
                
                <p><strong>ğŸ” ä½œæ¡ˆæ–¹æ³•ï¼š</strong><br>
                æ±¤å§†åˆ©ç”¨è‡ªå·±è¯ç†å­¦ä¸“ä¸šçŸ¥è¯†ï¼Œç²¾ç¡®è®¡ç®—äº†æ°°åŒ–ç‰©çš„è‡´æ­»å‰‚é‡ã€‚ä»–è¶ç€ä¸ºæ¯”å°”ç«¯å’–å•¡çš„æœºä¼šï¼Œå°†æ¯’ç‰©æŠ•å…¥æ¯”å°”çš„ç‰¹åˆ¶æ‹¿é“ä¸­ã€‚å’–å•¡çš„æµ“éƒé¦™å‘³å®Œç¾æ©ç›–äº†æ°°åŒ–ç‰©çš„è‹¦æä»å‘³ã€‚</p>
                
                <p><strong>â° æ—¶é—´çº¿ï¼š</strong><br>
                8:00 - æ¯”å°”åˆ°è¾¾å’–å•¡é¦†<br>
                8:20 - æ±¤å§†å¼€å§‹æœåŠ¡æ¯”å°”åŒºåŸŸ<br>
                8:22 - æ±¤å§†æŠ•æ¯’<br>
                8:28 - æ¯”å°”å–ä¸‹æ¯’å’–å•¡<br>
                8:30 - æ¯”å°”ä¸­æ¯’èº«äº¡</p>
                
                <p><strong>ğŸ•µï¸ å…¶ä»–å«Œç–‘äººï¼š</strong><br>
                â€¢ è‰¾ç±³ä¸½ï¼šè™½æœ‰æ¥è§¦å’–å•¡çš„æœºä¼šï¼Œä½†çœŸå¿ƒå…³å¿ƒæ¯”å°”<br>
                â€¢ é©¬å…‹ï¼šæœ‰ç»æµçº çº·ï¼Œä½†éœ€è¦æ¯”å°”ç»§ç»­åˆ›ä½œ<br>
                â€¢ ç‘ç§‹ï¼šå¤„ç†è´¢äº§åˆ†å‰²ï¼Œä½†ä»çˆ±ç€æ¯”å°”<br>
                â€¢ æ°å…‹ï¼šåˆ›æ„è¢«ç›—ç”¨ï¼Œä½†ç¼ºä¹åŒ–å­¦çŸ¥è¯†<br>
                â€¢ è¨æ‹‰ï¼šä½œå“è¢«æŠ„è¢­ï¼Œä½†åªæ˜¯è§‚å¯Ÿè€…</p>
                
                <p style="color: #ff8533;"><strong>å…³é”®çº¿ç´¢ï¼š</strong>åªæœ‰æ±¤å§†åŒæ—¶å…·å¤‡æ¥è§¦å’–å•¡çš„æœºä¼šã€æŠ•æ¯’çš„åŒ–å­¦çŸ¥è¯†å’Œå¼ºçƒˆçš„æ€äººåŠ¨æœºã€‚</p>
            </div>
        `;
    }

    overlay.style.display = 'flex';
    questionInput.disabled = true;
    submitBtn.disabled = true;
}

// é‡æ–°å¼€å§‹æ¸¸æˆ
function restartGame() {
    remainingTime = timeLimit;
    questionCount = 0; // é‡ç½®é—®é¢˜è®¡æ•°å™¨ï¼Œè¿™æ ·æ¸è¿›å¼æç¤ºä¹Ÿä¼šé‡ç½®
    collectedClues.clear();

    // é‡ç½®çº¿ç´¢åˆ—è¡¨
    const sceneCluesList = document.querySelector('#scene-clues .clues-list');
    const characterCluesList = document.querySelector('#character-clues .clues-list');

    if (sceneCluesList) {
        sceneCluesList.innerHTML = '<div class="clues-empty">å¼€å§‹æ”¶é›†ç°åœºçº¿ç´¢ï¼<br><small>æé—®ç›¸å…³é—®é¢˜æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•å…³é”®ä¿¡æ¯</small></div>';
    }

    if (characterCluesList) {
        characterCluesList.innerHTML = '<div class="clues-empty">å¼€å§‹æ”¶é›†äººç‰©çº¿ç´¢ï¼<br><small>æé—®ç›¸å…³é—®é¢˜æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•å…³é”®ä¿¡æ¯</small></div>';
    }

    chatHistory.innerHTML = '';
    questionInput.value = '';
    questionInput.disabled = false;
    submitBtn.disabled = false;
    document.getElementById('gameOverOverlay').style.display = 'none';

    // é‡ç½®çº¿ç´¢è®¡æ•°å™¨
    updateClueCounter();

    // é‡æ–°å¼€å§‹æ¸¸æˆ
    startGame();
}

// å¼¹çª—å†…å®¹å®šä¹‰
const modalContents = {
    ai: `
        <h2>ğŸ¤– è±†åŒ…AIåŠ©æ‰‹</h2>
        <ul>
            <li>ğŸ¯ <strong>çœŸå®AIå¯¹è¯</strong>ï¼šé›†æˆè±†åŒ…AIæ™ºèƒ½å›ç­”ç³»ç»Ÿ</li>
            <li>ğŸ’¬ <strong>æ™ºèƒ½æ¨ç†</strong>ï¼šåŸºäºæ¡ˆä»¶èƒŒæ™¯è¿›è¡Œåˆ†æåˆ¤æ–­</li>
            <li>ğŸ“± <strong>å®æ—¶å“åº”</strong>ï¼šAIå®æ—¶å¤„ç†å¹¶å›ç­”ä½ çš„é—®é¢˜</li>
            <li>ğŸ›¡ï¸ <strong>å¤‡ç”¨æœºåˆ¶</strong>ï¼šAPIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°é€»è¾‘</li>
            <li>ğŸ” <strong>ç¥ç§˜é£æ ¼</strong>ï¼šAIå›ç­”ç®€çŸ­ç¥ç§˜ï¼Œéœ€è¦ä½ ä»”ç»†æ¨ç†</li>
        </ul>
    `,
    case: `
        <h2>ğŸ“– æ¡ˆä»¶èƒŒæ™¯</h2>
        <div style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; line-height: 1.8;">
            <p><strong>ğŸ•°ï¸ æ—¶é—´</strong>ï¼š2024å¹´10æœˆ15æ—¥ï¼Œæ™šä¸Š8:30</p>
            <p><strong>ğŸ“ åœ°ç‚¹</strong>ï¼šé›¾éœ¾å¸‚ä¸­å¿ƒåŒºçš„"é‡‘å¶å’–å•¡é¦†"</p>
            <p><strong>ğŸ’€ å—å®³è€…</strong>ï¼šæ¯”å°”Â·å“ˆé‡Œæ£®ï¼ˆWilliam Harrisonï¼‰ï¼Œ45å²ï¼Œè‘—åä¾¦æ¢å°è¯´å®¶</p>
            
            <p style="color: #ff8533; margin-top: 1.5rem;"><strong>æ¡ˆä»¶æ¦‚è¿°ï¼š</strong></p>
            <p>å½“æ™šï¼Œæ¯”å°”å¦‚å¾€å¸¸ä¸€æ ·æ¥åˆ°ä»–æœ€å–œæ¬¢çš„å’–å•¡é¦†å†™ä½œã€‚è¿™å®¶å’–å•¡é¦†æ˜¯ä»–çš„"ç§˜å¯†åŸºåœ°"ï¼Œå‡ ä¹æ¯å¤©éƒ½ä¼šåœ¨å›ºå®šçš„è§’è½åº§ä½å¾…ä¸Šå‡ ä¸ªå°æ—¶ã€‚</p>
            <p>æ™šä¸Š8:30å·¦å³ï¼Œæ¯”å°”çªç„¶å€’åœ¨æ¡Œä¸Šï¼Œå‘¼å¸æ€¥ä¿ƒï¼Œé¢è‰²å‘ç´«ã€‚å‡ åˆ†é’Ÿåä¾¿åœæ­¢äº†å‘¼å¸ã€‚åŒ»ç”Ÿåˆæ­¥åˆ¤æ–­ä¸º<span style="color: #ff6600;">ä¸­æ¯’èº«äº¡</span>ã€‚</p>
            <p>ç°åœºå‘ç°ä¸€æ¯åˆšå–äº†ä¸€åŠçš„<span style="color: #ff6600;">ç‰¹åˆ¶æ‹¿é“å’–å•¡</span>ï¼Œæ¡Œä¸Šè¿˜æœ‰ä»–æ­£åœ¨æ’°å†™çš„æ–°å°è¯´æ‰‹ç¨¿ã€Šæ­»äº¡çš„çœŸç›¸ã€‹ã€‚</p>
            <p>å¥‡æ€ªçš„æ˜¯ï¼Œå½“æ™šå’–å•¡é¦†é‡Œæœ‰å‡ ä¸ªå¸¸å®¢ï¼Œä½†æ²¡æœ‰äººæ³¨æ„åˆ°å¼‚å¸¸æƒ…å†µ...</p>
        </div>
    `,
    rules: `
        <h2>ğŸ¯ æ¸¸æˆè§„åˆ™</h2>
        <ul>
            <li><strong>ğŸ” è°ƒæŸ¥ç›®æ ‡</strong>ï¼šé€šè¿‡æ™ºèƒ½æé—®æ‰¾å‡ºçœŸæ­£çš„å‡¶æ‰‹</li>
            <li><strong>ğŸ¤– AIåŠ©æ‰‹</strong>ï¼šè±†åŒ…AIåŸºäºæ¡ˆä»¶èƒŒæ™¯æä¾›çº¿ç´¢ï¼ˆä½†ä¼šè¯¯å¯¼ï¼ï¼‰</li>
            <li><strong>â° æ—¶é—´é™åˆ¶</strong>ï¼š30åˆ†é’Ÿå†…ç ´è§£è°œé¢˜</li>
            <li><strong>ğŸ“‹ çº¿ç´¢ç³»ç»Ÿ</strong>ï¼šé‡è¦å‘ç°ä¼šè‡ªåŠ¨è®°å½•åˆ°è¯æ®åº“</li>
            <li><strong>ğŸ† è·èƒœæ¡ä»¶</strong>ï¼šæ­£ç¡®æŒ‡å‡ºå‡¶æ‰‹å³å¯è·èƒœ</li>
            <li><strong>ğŸ’¡ æé—®æŠ€å·§</strong>ï¼šå¯è¯¢é—®ç°åœºç»†èŠ‚ã€äººç‰©å…³ç³»ã€æ—¶é—´çº¿ç­‰</li>
            <li><strong>âš ï¸ æ³¨æ„</strong>ï¼šAIå¯èƒ½ä¼šè¯¯å¯¼ä½ ï¼Œéœ€è¦ç‹¬ç«‹æ€è€ƒï¼</li>
        </ul>
    `
};

// å¼¹çª—åŠŸèƒ½
function showModal(title, content) {
    const modal = document.getElementById('infoModal');
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = content;
    const modalTitle = document.getElementById('modalTitle');
    modalTitle.textContent = title;
    modal.style.display = 'block';
}

function hideModal() {
    document.getElementById('infoModal').style.display = 'none';
}

// äº‹ä»¶ç›‘å¬å™¨
startBtn.addEventListener('click', startGame);
submitBtn.addEventListener('click', async () => {
    const question = questionInput.value.trim();
    if (question) {
        await handleQuestion(question);
        questionInput.value = '';
    }
});
questionInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        const question = questionInput.value.trim();
        if (question) {
            await handleQuestion(question);
            questionInput.value = '';
        }
    }
});
document.getElementById('restartBtn').addEventListener('click', restartGame);

// ä¿¡æ¯æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
document.getElementById('aiInfoBtn').addEventListener('click', () => doubaoAI.showAIHelper());
document.getElementById('caseInfoBtn').addEventListener('click', () => showModal('æ¡ˆä»¶èƒŒæ™¯', modalContents.case));
document.getElementById('rulesInfoBtn').addEventListener('click', () => doubaoAI.showGameRules());
document.getElementById('closeModal').addEventListener('click', hideModal);

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.getElementById('infoModal').addEventListener('click', (e) => {
    if (e.target.id === 'infoModal') {
        hideModal();
    }
});

// ESCé”®å…³é—­å¼¹çª—
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        hideModal();
    }
});

// æµ‹è¯•APIè°ƒç”¨
async function testAPI() {
    console.log('ğŸ§ª å¼€å§‹æµ‹è¯•APIè°ƒç”¨...');
    try {
        const response = await fetch(AI_CONFIG.endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AI_CONFIG.apiKey}`,
                'X-Request-Id': Date.now().toString()
            },
            body: JSON.stringify({
                model: AI_CONFIG.model,
                messages: [{
                    role: 'user',
                    content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯'
                }],
                max_tokens: 100,
                temperature: 0.7,
                stream: false
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('APIé”™è¯¯è¯¦æƒ…:', errorData);
            throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
        }

        const data = await response.json();
        console.log('âœ… APIè°ƒç”¨æˆåŠŸï¼');
        console.log('APIå“åº”:', data);
        return true;
    } catch (error) {
        console.error('âŒ APIè°ƒç”¨å¤±è´¥:', error);
        return false;
    }
}

// é¡µé¢åŠ è½½æ—¶æµ‹è¯•API
window.addEventListener('load', testAPI);